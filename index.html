<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <title>MAS Houston tracking tool v2</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.0/+esm';
    window.supabaseCreateClient = createClient;
  </script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    :root {
      --accent: #0ea5e9;
      --accent-contrast: #ffffff;
      --border: #e5e7eb;
      --text: #111111;
      --muted: #6b7280;
      --bg: #f7f7f7;
      --surface: #ffffff;
      --present: #2e7d32; /* marker color */
      --present-cell: #e8f5e9;
      --absent-cell: #fdecea;
      --excused-cell: #eef3fa;
      --not-reported: #ffffff;
      --summary-bg: #f8fafc;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      color: var(--text);
      line-height: 1.5;
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }
    
    /* Animations */
    @keyframes float { 
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }
    @keyframes racing-stripe {
      0% { background-position: 0 0; }
      100% { background-position: 100px 0; }
    }
    .racing-bg {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 0;
      opacity: 0.03;
      background: repeating-linear-gradient(90deg, transparent, transparent 40px, var(--accent) 40px, var(--accent) 50px);
      animation: racing-stripe 2s linear infinite;
    }
    .drift-item {
      position: fixed;
      font-size: 24px;
      opacity: 0.4;
      pointer-events: none;
      z-index: 1;
    }
    
    /* Arcade theme variables override */
    body.theme-arcade {
      --accent: #00e5ff;
      --accent-contrast: #0b1120;
      --border: #233045;
      --text: #e5e7eb;
      --muted: #94a3b8;
      --bg: #0b1120;
      --surface: #0f172a;
      --present-cell: rgba(34,197,94,0.18);
      --absent-cell: rgba(239,68,68,0.18);
      --excused-cell: rgba(59,130,246,0.18);
      --not-reported: #0f172a;
      --summary-bg: #0b1225;
      background: radial-gradient(1200px 600px at 50% -200px, #0b1120 0%, #050b16 100%);
    }
    main {
      padding: 24px 28px 32px;
      max-width: 1200px;
      margin: 24px auto;
      background: var(--surface);
      border-radius: 12px;
      min-height: 80vh;
      position: relative;
      z-index: 2;
      animation: float 6s ease-in-out infinite;
    }
    h1 {
      margin: 0 0 8px;
      font-size: 32px;
      text-align: center;
      font-family: 'Press Start 2P', cursive;
      letter-spacing: 2px;
      color: var(--accent);
      text-shadow: 2px 2px 0 #999;
    }
    .mission-vision {
      display: none;
    }
    h2 {
      margin: 28px 0 12px;
      font-size: 18px;
      letter-spacing: 0.2px;
    }
    p {
      margin: 0 0 10px;
      color: var(--muted);
    }
    .metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 14px;
      margin: 20px 0 30px;
    }
    .metric {
      padding: 16px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      transition: all 0.3s ease;
    }
    .metric:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(34, 211, 238, 0.3);
    }
    .metric.good { border-left: 3px solid #2e7d32; }
    .metric.good:hover { box-shadow: 0 4px 12px rgba(34, 197, 94, 0.4); }
    .metric.bad { border-left: 3px solid #c62828; }
    .metric.bad:hover { box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4); }
    .metric.neutral { border-left: 3px solid #9ca3af; }
    .metric .label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--accent);
      font-weight: 700;
    }
    .metric .value {
      font-size: 22px;
      margin-top: 6px;
      font-weight: 700;
      color: var(--text);
    }
    /* Metrics table (CSV-like) */
    .metrics-table-wrapper { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; }
    table.metrics-table { width: 100%; border-collapse: collapse; font-size: 14px; }
    .metrics-table th, .metrics-table td { padding: 10px 12px; border-bottom: 1px solid var(--border); text-align: left; }
    .metrics-table th { font-weight: 600; color: var(--muted); background: var(--summary-bg); }
    .metrics-table tr:last-child td { border-bottom: none; }
    .metrics-table td.value.good { color: #2e7d32; }
    .metrics-table td.value.bad { color: #c62828; }
    .metrics-table td.value.neutral { color: #6b7280; }

    /* Leaderboards */
    .leaderboards { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 14px; margin-top: 16px; }
    .leaderboard { background: var(--surface); border: 2px solid var(--accent); border-radius: 10px; padding: 12px; box-shadow: 0 0 8px rgba(14, 165, 233, 0.2); transition: all 0.3s; }
    .leaderboard:hover { transform: translateY(-2px); box-shadow: 0 0 15px rgba(14, 165, 233, 0.4); }
    .leaderboard.leaderboard-streaks { border-color: #22c55e; box-shadow: 0 0 8px rgba(34, 197, 94, 0.3); }
    .leaderboard.leaderboard-streaks:hover { box-shadow: 0 0 15px rgba(34, 197, 94, 0.5); }
    .leaderboard.leaderboard-attention { border-color: #ef4444; box-shadow: 0 0 8px rgba(239, 68, 68, 0.3); }
    .leaderboard.leaderboard-attention:hover { box-shadow: 0 0 15px rgba(239, 68, 68, 0.5); }
    .leaderboard h3 { 
      margin: -12px -12px 12px -12px;
      padding: 12px 16px;
      font-size: 13px;
      font-weight: 700;
      color: white;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      background: linear-gradient(90deg, rgba(14, 165, 233, 0.8), rgba(59, 130, 246, 0.8));
      border-radius: 10px 10px 0 0;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
    }
    .leaderboard.leaderboard-streaks h3 { background: linear-gradient(90deg, rgba(34, 197, 94, 0.8), rgba(34, 197, 94, 0.6)); }
    .leaderboard.leaderboard-attention h3 { background: linear-gradient(90deg, rgba(239, 68, 68, 0.8), rgba(239, 68, 68, 0.6)); }
    .leaderboard-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 6px; border-bottom: 1px solid rgba(14, 165, 233, 0.15); }
    .leaderboard-item:last-child { border-bottom: none; }
    .lb-name { font-weight: 600; color: var(--text); font-size: 14px; }
    .lb-score { font-weight: 700; color: var(--accent); font-size: 13px; }

    #usrah-board .usrah-footer {
      margin-top: 18px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      text-align: center;
      color: var(--muted);
      font-size: 12px;
    }
    #usrah-board .usrah-footer img {
      max-width: 220px;
      width: 100%;
      height: auto;
      filter: drop-shadow(0 6px 18px rgba(0, 0, 0, 0.25));
    }

    /* Usrah metrics table (arcade-styled) */
    .usrah-table-wrapper { background: var(--surface); border: 2px solid #22c55e; border-radius: 10px; overflow: hidden; box-shadow: 0 0 8px rgba(34, 197, 94, 0.25); transition: all 0.3s; }
    .usrah-table-wrapper:hover { box-shadow: 0 0 15px rgba(34, 197, 94, 0.4); }
    table.usrah-table { width: 100%; border-collapse: collapse; font-size: 14px; }
    .usrah-table th, .usrah-table td { padding: 12px 14px; border-bottom: 1px solid var(--border); text-align: left; }
    .usrah-table th { font-weight: 700; color: var(--text); background: var(--summary-bg); letter-spacing: 0.5px; }
    .usrah-table tr:nth-child(even) td { background: rgba(14,165,233,0.06); }
    .usrah-table tr:last-child td { border-bottom: none; }
    .usrah-table .rank { width: 60px; color: var(--muted); font-weight: 700; }
    .usrah-table .name { font-weight: 700; color: var(--text); }
    .usrah-table .val { font-weight: 700; color: var(--accent); }
    .usrah-sort { display: inline-flex; align-items: center; gap: 4px; cursor: pointer; user-select: none; }
    .usrah-sort .arrow { color: var(--muted); font-size: 12px; }
    .usrah-sort.active { color: var(--accent); }
    .usrah-sort.active .arrow { color: var(--accent); }
    
    /* D3 Visualization Section */
    #viz-section { margin: 32px 0; }
    .viz-container { display: grid; grid-template-columns: 220px 1fr 280px; gap: 16px; min-height: 600px; }
    .viz-panel { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 16px; box-shadow: 0 0 10px rgba(14, 165, 233, 0.15); transition: all 0.3s; }
    .viz-panel:hover { box-shadow: 0 0 20px rgba(14, 165, 233, 0.3); }
    .viz-controls h3, .viz-details h3 { margin: 0 0 12px; font-size: 14px; color: var(--accent); letter-spacing: 0.5px; }
    .viz-control-group { margin-bottom: 8px; }
    .viz-control-group label { display: block; font-size: 12px; font-weight: 600; margin-bottom: 6px; color: var(--muted); }
    .viz-control-group select, .viz-control-group input { width: 100%; padding: 8px; background: #0b1225; border: 1px solid var(--border); border-radius: 4px; color: var(--text); font-size: 13px; transition: all 0.2s; }
    .viz-control-group select:focus, .viz-control-group input:focus { border-color: var(--accent); box-shadow: 0 0 8px rgba(14, 165, 233, 0.3); outline: none; }
    .option-stack { display: grid; grid-template-columns: 1fr; gap: 4px; }
    .option-btn { position: relative; display: flex; align-items: center; gap: 8px; padding: 6px 8px; border: 1px solid var(--border); border-radius: 6px; background: rgba(14, 165, 233, 0.035); cursor: pointer; transition: all 0.2s ease; }
    .option-btn:hover { border-color: var(--accent); box-shadow: 0 0 0 1px rgba(14, 165, 233, 0.12); }
    .option-btn input { position: absolute; opacity: 0; pointer-events: none; }
    .option-btn span { font-weight: 600; color: var(--text); }
    .option-btn.is-active { border-color: var(--accent); background: rgba(14, 165, 233, 0.14); box-shadow: 0 0 0 1px rgba(14, 165, 233, 0.18); }
    .option-btn.is-active span { color: var(--accent); }
    #d3-chart { background: var(--surface); border-radius: 8px; position: relative; overflow: visible; }
    .member-box { cursor: pointer; transition: all 0.3s; }
    .member-box:hover { opacity: 0.9; filter: drop-shadow(0 0 15px currentColor); }
    .member-box circle { stroke-width: 2; transition: all 0.3s; }
    .member-box:hover circle { filter: brightness(1.2); }
    .member-box text { pointer-events: none; }
    .tier-label { font-size: 13px; font-weight: 700; fill: var(--text); paint-order: stroke fill; stroke: var(--surface); stroke-width: 3; }
    .viz-details .detail-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border); }
    .viz-details .detail-label { color: var(--muted); font-size: 12px; }
    .viz-details .detail-value { color: var(--text); font-weight: 600; font-size: 13px; }
    .viz-details .member-name { font-size: 16px; font-weight: 700; color: var(--accent); margin-bottom: 12px; }
    .viz-details .empty-state { color: var(--muted); text-align: center; padding: 40px 0; font-size: 13px; }
    @media (max-width: 1200px) {
      .viz-container { grid-template-columns: 1fr; }
      .viz-controls, .viz-details { max-width: 500px; margin: 0 auto; }
    }
    .grid-wrapper {
      overflow: visible;
      background: var(--surface);
    }
    .members-list-container { padding: 20px; }
    .members-list-container h2 { margin: 0 0 16px; color: var(--accent); }
    .members-table { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
    .members-table table { width: 100%; border-collapse: collapse; }
    .members-table th { padding: 12px 16px; background: var(--summary-bg); font-weight: 700; text-align: left; border-bottom: 2px solid var(--border); color: var(--text); }
    .members-table td { padding: 12px 16px; border-bottom: 1px solid var(--border); }
    .members-table tr:hover { background: rgba(34, 211, 238, 0.05); }
    .members-table tr:last-child td { border-bottom: none; }
    .muted { color: var(--muted); }
    .warning {
      border: 1px solid #d9a441;
      background: #fff8ea;
      color: #6b4a00;
      padding: 12px;
      margin: 12px 0;
      font-size: 14px;
    }
    @media (max-width: 768px) {
      h1 {
        font-size: 22px;
        letter-spacing: 1px;
      }
      .mission-vision {
        padding: 10px 12px;
        margin: 12px 0 16px;
      }
      .mission-vision p {
        font-size: 12px;
        margin: 4px 0;
      }
      body {
        font-size: 14px;
      }
      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
        padding: 16px;
        position: relative;
      }
      nav {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      nav a {
        margin-left: 0;
        font-size: 13px;
      }
      #print-btn {
        position: static;
        width: 100%;
        margin-bottom: 12px;
      }
      main {
        padding: 16px;
      }
      h1 {
        font-size: 20px;
        margin-bottom: 12px;
      }
      p {
        font-size: 13px;
      }
      .metrics {
        grid-template-columns: 1fr;
        gap: 10px;
        margin: 16px 0 24px;
      }
    }
  </style>
</head>
<body class="theme-arcade">
  <div class="racing-bg"></div>
  <div class="drift-item" style="top:10%; left:5%; animation-delay:0s;">🏁</div>
  <div class="drift-item" style="top:30%; left:80%; animation-delay:1.5s;">🏆</div>
  <div class="drift-item" style="top:50%; left:10%; animation-delay:3s;">⭐</div>
  <div class="drift-item" style="top:70%; left:70%; animation-delay:4.5s;">💨</div>
  <div class="drift-item" style="top:85%; left:30%; animation-delay:2s;">🎮</div>
  
  
  <button id="attendance-btn" onclick="playSound('ach'); window.location.href='attendance.html'" style="position: fixed; top: 20px; right: 20px; padding: 10px 15px;">Usrah Attendance</button>
  <div id="confetti"></div>
  <main>
    <section id="dashboard">
      <h1>HOUSTON TARBIYAH TRACKING v2</h1>
      <div class="mission-vision">
        <p><strong>Mission:</strong> Build strong, accountable usrahs that nurture growth and development</p>
        <p><strong>Vision:</strong> A community of active, engaged members driving tarbiya forward</p>
      </div>
      
      <section id="viz-section">
        <div class="viz-container">
          <div class="viz-panel viz-controls">
            <h3>🎮 CONTROLS</h3>
            <div class="viz-control-group">
              <label style="display: block; margin-bottom: 4px; font-weight: 700; font-size: 12px;">Group By</label>
              <div id="viz-group-checkboxes" class="option-stack">
                <label class="option-btn is-active"><input type="radio" name="groupby" class="viz-group-rb" value="usrah" checked /><span>Usrah</span></label>
                <label class="option-btn"><input type="radio" name="groupby" class="viz-group-rb" value="region" /><span>Region</span></label>
                <label class="option-btn"><input type="radio" name="groupby" class="viz-group-rb" value="attendance" /><span>Attendance</span></label>
                <label class="option-btn"><input type="radio" name="groupby" class="viz-group-rb" value="streak" /><span>Streak</span></label>
                <label class="option-btn"><input type="radio" name="groupby" class="viz-group-rb" value="status" /><span>Status</span></label>
                <label class="option-btn"><input type="radio" name="groupby" class="viz-group-rb" value="pdp" /><span>PDP</span></label>
              </div>
            </div>
            <div class="viz-control-group">
              <label style="display: block; margin-bottom: 4px; font-weight: 700; font-size: 12px;">Color By</label>
              <div id="viz-color-checkboxes" class="option-stack">
                <label class="option-btn is-active"><input type="radio" class="viz-color-rb" name="color" value="usrah" checked /><span>Usrah</span></label>
                <label class="option-btn"><input type="radio" class="viz-color-rb" name="color" value="region" /><span>Region</span></label>
                <label class="option-btn"><input type="radio" class="viz-color-rb" name="color" value="attendance" /><span>Attendance</span></label>
                <label class="option-btn"><input type="radio" class="viz-color-rb" name="color" value="streak" /><span>Streak</span></label>
                <label class="option-btn"><input type="radio" class="viz-color-rb" name="color" value="brotherhood" /><span>Brotherhood</span></label>
                <label class="option-btn"><input type="radio" class="viz-color-rb" name="color" value="leadership" /><span>Leadership</span></label>
              </div>
            </div>
            <div id="viz-legend" style="margin-top: 16px; padding: 12px; background: var(--summary-bg); border-radius: 6px; font-size: 12px;"></div>
          </div>
          
          <div class="viz-panel" id="d3-chart"></div>
          
          <div class="viz-panel viz-details">
            <h3>📊 MEMBER DETAILS</h3>
            <div id="member-details">
              <div class="empty-state">Click a member to view details</div>
            </div>
          </div>
        </div>
      </section>

      <div id="warning" class="warning" style="display:none;"></div>
      <div class="metrics" id="metrics"></div>
      <div class="grid-wrapper" id="grid-wrapper">
        <div class="members-list-container">
          <h2>Usrah Members</h2>
          <div class="members-search">
            <input type="text" id="members-search" placeholder="Search members..." style="width: 100%; padding: 10px; margin-bottom: 16px; border: 1px solid var(--border); border-radius: 4px; background: var(--surface); color: var(--text);">
          </div>
          <div id="members-table" class="members-table"></div>
        </div>
      </div>
    </section>

    <section id="usrah-board">
      <h2>Usrah Leaderboard</h2>
      <div id="usrah-leaderboard" class="usrah-table-wrapper"></div>
      <div class="usrah-footer">
        <img src="Asset 4leaf.png" alt="MASHUB logo">
        <p>&copy; 2025 Muslim American Society Houston. All rights reserved.</p>
      </div>
    </section>

    

    
  </main>
  <script>
    // =====================
    // ARCADE HELPERS (LIGHT MODE)
    // =====================
    let leaderboardMetric = 'streak'; // 'streak', 'attendance', 'brotherhood'
    let memberTableFilters = { column: null, ascending: true };
    let usrahTableFilters = { column: null, ascending: true };
    
    function showToast(text) {
      const el = document.createElement('div');
      el.className = 'toast';
      el.textContent = text;
      const container = document.querySelector('main') || document.body;
      container.appendChild(el);
      setTimeout(() => el.remove(), 2500);
    }

    function playSound(type) {
      const Ctx = window.AudioContext || window.webkitAudioContext;
      if (!Ctx) return;
      const ctx = new Ctx();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.connect(g); g.connect(ctx.destination);
      o.type = type === 'ach' ? 'triangle' : 'square';
      o.frequency.setValueAtTime(type === 'ach' ? 880 : 660, ctx.currentTime);
      g.gain.setValueAtTime(0.001, ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime + 0.01);
      o.start();
      g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.2);
      o.stop(ctx.currentTime + 0.22);
    }

    function confettiBurst(count = 30) {
      const container = document.getElementById('confetti');
      if (!container) return;
      for (let i = 0; i < count; i++) {
        const piece = document.createElement('div');
        piece.className = `confetti-piece c${1 + (i % 4)}`;
        piece.style.left = Math.random() * 100 + '%';
        piece.style.animationDelay = (Math.random() * 0.5) + 's';
        piece.style.transform = `translateY(-20px) rotate(${Math.random()*180}deg)`;
        container.appendChild(piece);
        setTimeout(() => piece.remove(), 2200);
      }
    }

    function awardPoints(points, reason = '') {
      if (reason) showToast(`+${points} XP • ${reason}`);
      playSound('coin');
      confettiBurst();
    }
    
    // D3 VISUALIZATION
    // ============================================
    let vizSettings = { 
      groupBy: new Set(['usrah']), 
      colorBy: 'usrah',
      filter: '' 
    };
    
    function getAttendanceRate(personId) {
      const records = DATA.attendance.filter(a => a.person_id === personId && visibleWeekIds.has(a.week_id));
      const present = records.filter(r => r.status === 'present').length;
      const total = records.length;
      return total === 0 ? 0 : present / total;
    }
    
    function renderD3Visualization() {
      const chartEl = document.getElementById('d3-chart');
      if (!chartEl) return;
      
      // Get people with metrics
      let people = DATA.people.filter(p => p.active).map(p => {
        const rate = getAttendanceRate(p.person_id);
        const streak = getBestStreak(p.person_id);
        const usrah = USRAH_BY_ID.get(p.usrah_id);
        return {
          ...p,
          attendanceRate: rate,
          streak: streak,
          usrahName: usrah ? usrah.usrah_name : 'Unknown',
          region: usrah ? usrah.region : 'Unknown',
          tier: rate >= 0.8 ? 'excellent' : rate >= 0.6 ? 'good' : rate >= 0.4 ? 'okay' : 'needs-attention'
        };
      });
      
      // Build groups based on selected groupBy options
      let groups = [];
      const selectedGroups = Array.from(vizSettings.groupBy);
      
      if (selectedGroups.includes('region')) {
        const regionMap = new Map();
        people.forEach(p => {
          if (!regionMap.has(p.region)) regionMap.set(p.region, []);
          regionMap.get(p.region).push(p);
        });
        groups = Array.from(regionMap.entries()).map(([region, members]) => ({
          label: region,
          members,
          groupKey: region
        }));
      } else if (selectedGroups.includes('usrah')) {
        const usrahMap = new Map();
        people.forEach(p => {
          if (!usrahMap.has(p.usrah_id)) usrahMap.set(p.usrah_id, []);
          usrahMap.get(p.usrah_id).push(p);
        });
        groups = Array.from(usrahMap.entries()).map(([id, members]) => ({
          label: members[0].usrahName,
          members,
          groupKey: id
        }));
      } else if (selectedGroups.includes('attendance')) {
        const tierMap = { excellent: [], good: [], okay: [], 'needs-attention': [] };
        people.forEach(p => tierMap[p.tier].push(p));
        groups = [
          { label: '80%+ (Excellent)', members: tierMap.excellent, groupKey: 'excellent' },
          { label: '60-79% (Good)', members: tierMap.good, groupKey: 'good' },
          { label: '40-59% (Okay)', members: tierMap.okay, groupKey: 'okay' },
          { label: '<40% (Needs Attention)', members: tierMap['needs-attention'], groupKey: 'needs-attention' }
        ].filter(g => g.members.length > 0);
      } else if (selectedGroups.includes('streak')) {
        const streakMap = { high: [], medium: [], low: [] };
        people.forEach(p => {
          if (p.streak >= 3) streakMap.high.push(p);
          else if (p.streak >= 1) streakMap.medium.push(p);
          else streakMap.low.push(p);
        });
        groups = [
          { label: '3+ Weeks Streak', members: streakMap.high, groupKey: 'high' },
          { label: '1-2 Weeks Streak', members: streakMap.medium, groupKey: 'medium' },
          { label: 'No Streak', members: streakMap.low, groupKey: 'low' }
        ].filter(g => g.members.length > 0);
      } else if (selectedGroups.includes('pdp')) {
        const pdpMap = { has: [], none: [] };
        people.forEach(p => {
          if (p.development_plan) pdpMap.has.push(p);
          else pdpMap.none.push(p);
        });
        groups = [
          { label: 'Has PDP', members: pdpMap.has, groupKey: 'has' },
          { label: 'No PDP', members: pdpMap.none, groupKey: 'none' }
        ].filter(g => g.members.length > 0);
      } else if (selectedGroups.includes('leadership')) {
        const leadMap = { leaders: [], members: [] };
        people.forEach(p => {
          if (p.leadership) leadMap.leaders.push(p);
          else leadMap.members.push(p);
        });
        groups = [
          { label: 'Leaders', members: leadMap.leaders, groupKey: 'leaders' },
          { label: 'Members', members: leadMap.members, groupKey: 'members' }
        ].filter(g => g.members.length > 0);
      } else if (selectedGroups.includes('status')) {
        const statusMap = { member: [], interested: [] };
        people.forEach(p => {
          if (p.is_member) statusMap.member.push(p);
          else statusMap.interested.push(p);
        });
        groups = [
          { label: 'Members', members: statusMap.member, groupKey: 'member' },
          { label: 'Interested', members: statusMap.interested, groupKey: 'interested' }
        ].filter(g => g.members.length > 0);
      } else {
        groups = [{ label: 'All', members: people, groupKey: 'all' }];
      }
      
      // Apply coloring based on colorBy
      const colorMap = {};
      const regionColors = { 'Southeast': '#22c55e', 'West': '#22d3ee', 'Southwest': '#f59e0b' };
      const tierColors = { 'excellent': '#22c55e', 'good': '#22d3ee', 'okay': '#f59e0b', 'needs-attention': '#ef4444' };
      const streakColors = { 'high': '#22c55e', 'medium': '#22d3ee', 'low': '#ef4444' };
      const brotColors = { 5: '#22c55e', 4: '#84cc16', 3: '#f59e0b', 2: '#fb923c', 1: '#ef4444' };
      
      if (vizSettings.colorBy === 'region') {
        people.forEach(p => colorMap[p.person_id] = regionColors[p.region] || '#999');
      } else if (vizSettings.colorBy === 'attendance') {
        people.forEach(p => colorMap[p.person_id] = tierColors[p.tier] || '#999');
      } else if (vizSettings.colorBy === 'streak') {
        people.forEach(p => {
          if (p.streak >= 3) colorMap[p.person_id] = streakColors.high;
          else if (p.streak >= 1) colorMap[p.person_id] = streakColors.medium;
          else colorMap[p.person_id] = streakColors.low;
        });
      } else if (vizSettings.colorBy === 'brotherhood') {
        people.forEach(p => {
          const rating = p.brotherhood_rating || 0;
          colorMap[p.person_id] = brotColors[Math.min(5, Math.max(1, rating))] || '#999';
        });
      } else if (vizSettings.colorBy === 'leadership') {
        people.forEach(p => colorMap[p.person_id] = p.leadership ? '#f59e0b' : '#94a3b8');
      } else {
        const colors = ['#22c55e', '#22d3ee', '#f59e0b', '#ef4444', '#a78bfa', '#ec4899'];
        let colorIdx = 0;
        groups.forEach(g => {
          const color = colors[colorIdx % colors.length];
          g.members.forEach(m => colorMap[m.person_id] = color);
          colorIdx++;
        });
      }
      
      // Build D3 layout with gravity clustering around labels
      const width = chartEl.clientWidth - 32;
      const circleRadius = 24; // Larger circles to fit names
      
      let svg = d3.select('#d3-chart').select('svg');
      if (svg.empty()) {
        svg = d3.select('#d3-chart')
          .append('svg')
          .attr('width', width)
          .style('overflow', 'visible');
      }
      
      // Flatten data with packed rings and flow layout (fills rows using available width)
      const flatData = [];
      
      const layoutPacked = (members, startAngle) => {
        const positions = [];
        const pad = 6;
        let idx = 0;
        let ring = 1;
        let maxRadius = 0;
        while (idx < members.length) {
          const ringRadius = ring === 1 ? circleRadius + 12 : ring * (circleRadius * 2 + pad);
          const capacity = Math.max(1, Math.floor((2 * Math.PI * ringRadius) / (2 * circleRadius + pad)));
          maxRadius = Math.max(maxRadius, ringRadius);
          for (let j = 0; j < capacity && idx < members.length; j++, idx++) {
            const angle = startAngle + (j / capacity) * Math.PI * 2;
            positions.push({
              member: members[idx],
              dx: Math.cos(angle) * ringRadius,
              dy: Math.sin(angle) * ringRadius
            });
          }
          ring += 1;
        }
        return { positions, maxRadius };
      };
      
      const layoutBlocks = groups.map(group => {
        const seed = Array.from(group.label || '').reduce((sum, ch) => sum + ch.charCodeAt(0), 0);
        const startAngle = ((seed % 360) * Math.PI) / 180;
        const { positions, maxRadius } = layoutPacked(group.members, startAngle);
        const blockPad = 48;
        const blockWidth = Math.max(220, maxRadius * 2 + circleRadius * 2 + blockPad);
        const blockHeight = Math.max(180, maxRadius * 2 + circleRadius * 2 + blockPad);
        const labelColor = positions.length ? (colorMap[positions[0].member.person_id] || 'var(--accent)') : 'var(--accent)';
        return { group, positions, maxRadius, blockWidth, blockHeight, labelColor };
      });
      
      const flatPadding = 40;
      const gapX = 40;
      const gapY = 60;
      let cursorX = flatPadding;
      let cursorY = 80;
      let rowHeight = 0;
      
      layoutBlocks.forEach(block => {
        if (cursorX + block.blockWidth > width && cursorX > flatPadding) {
          cursorX = flatPadding;
          cursorY += rowHeight + gapY;
          rowHeight = 0;
        }
        const centerX = cursorX + block.blockWidth / 2;
        const centerY = cursorY + block.blockHeight / 2;
        rowHeight = Math.max(rowHeight, block.blockHeight);
        
        flatData.push({
          type: 'label',
          label: block.group.label,
          x: centerX,
          y: centerY,
          color: block.labelColor
        });
        
        block.positions.forEach(pos => {
          flatData.push({
            type: 'circle',
            member: pos.member,
            x: centerX + pos.dx,
            y: centerY + pos.dy,
            baseX: centerX,
            baseY: centerY,
            color: colorMap[pos.member.person_id] || '#22d3ee'
          });
        });
        
        cursorX += block.blockWidth + gapX;
      });
      const svgHeight = cursorY + rowHeight + flatPadding;
      
      svg.transition().duration(500).attr('height', svgHeight);
      
      // Labels
      const labels = svg.selectAll('.tier-label')
        .data(flatData.filter(d => d.type === 'label'), d => d.label);
      
      labels.exit().remove();
      
      const labelsEnter = labels.enter()
        .append('text')
        .attr('class', 'tier-label')
        .attr('text-anchor', 'middle')
        .attr('dominant-baseline', 'middle')
        .style('opacity', 0)
        .style('font-size', '14px')
        .style('font-weight', '700')
        .style('fill', d => d.color || 'var(--accent)');
      
      labelsEnter.merge(labels)
        .transition()
        .duration(500)
        .attr('x', d => d.x)
        .attr('y', d => d.y)
        .attr('dominant-baseline', 'middle')
        .style('opacity', 1)
        .style('fill', d => d.color || 'var(--accent)')
        .text(d => d.label);
      
      // Member circles
      const circles = svg.selectAll('.member-box')
        .data(flatData.filter(d => d.type === 'circle'), d => d.member.person_id);
      
      circles.exit()
        .transition()
        .duration(300)
        .style('opacity', 0)
        .remove();
      
      const circlesEnter = circles.enter()
        .append('g')
        .attr('class', 'member-box')
        .attr('data-person-id', d => d.member.person_id)
        .style('cursor', 'pointer')
        .style('opacity', 0);
      
      circlesEnter.append('circle')
        .attr('r', circleRadius)
        .attr('cx', 0)
        .attr('cy', 0);
      
      circlesEnter.append('text')
        .attr('text-anchor', 'middle')
        .attr('dy', '0.35em')
        .style('pointer-events', 'none')
        .style('font-size', '11px')
        .style('font-weight', '700')
        .style('fill', '#0b1120')
        .text(d => {
          const parts = d.member.name.trim().split(/\s+/);
          return parts[parts.length - 1] || d.member.name;
        });
      
      // Update circles with smooth, non-jerky motion
      const allCircles = circlesEnter.merge(circles);
      
      // Spawn from random positions near the group center to avoid jumps from (0,0)
      circlesEnter.attr('transform', d => {
        const jitter = 40;
        const rx = d.x + (Math.random() - 0.5) * jitter;
        const ry = d.y + (Math.random() - 0.5) * jitter;
        return `translate(${rx}, ${ry})`;
      });
      
      allCircles
        .transition()
        .duration(800)
        .ease(d3.easeCubicOut)
        .attr('transform', d => `translate(${d.x}, ${d.y})`)
        .style('opacity', 1);
      
      allCircles.select('circle')
        .transition()
        .duration(700)
        .attr('fill', d => d.color)
        .attr('stroke', d => d.color);
      
      allCircles.on('click', function(event, d) {
        showMemberDetails(d.member);
      });

      // Keep labels above circles for readability
      svg.selectAll('.tier-label').raise();
      
      // Update legend
      updateLegend();
    }
    
    function updateLegend() {
      const legendEl = document.getElementById('viz-legend');
      if (!legendEl) return;
      
      let html = '<strong style="display: block; margin-bottom: 8px;">Legend:</strong>';
      
      if (vizSettings.colorBy === 'region') {
        html += '<div>🟢 Southeast | 🔵 West | 🟡 Southwest</div>';
      } else if (vizSettings.colorBy === 'attendance') {
        html += '<div>🟢 80%+ | 🔵 60-79% | 🟡 40-59% | 🔴 <40%</div>';
      } else if (vizSettings.colorBy === 'streak') {
        html += '<div>🟢 3+ weeks | 🔵 1-2 weeks | 🔴 No streak</div>';
      } else if (vizSettings.colorBy === 'brotherhood') {
        html += '<div>🟢 5 | 🟡 4 | 🟠 3 | 🟠 2 | 🔴 1</div>';
      } else if (vizSettings.colorBy === 'leadership') {
        html += '<div>🟡 Leader | 🔘 Member</div>';
      } else {
        html += '<div>Grouped by: ' + Array.from(vizSettings.groupBy).join(', ') + '</div>';
      }
      
      legendEl.innerHTML = html;
    }
    
    function showMemberDetails(member) {
      playSound('note');
      const detailsEl = document.getElementById('member-details');
      const rate = formatPercent(member.attendanceRate);
      const usrah = USRAH_BY_ID.get(member.usrah_id);
      const recentWeeks = visibleWeeks.slice(-4);
      const recentRecords = DATA.attendance.filter(a => 
        a.person_id === member.person_id && recentWeeks.map(w => w.week_id).includes(a.week_id)
      );
      const recentPresent = recentRecords.filter(r => r.status === 'present').length;
      const joinDate = member.join_date ? new Date(member.join_date).toLocaleDateString() : 'N/A';
      const daysSinceJoin = member.join_date ? Math.floor((new Date() - new Date(member.join_date)) / (1000 * 60 * 60 * 24)) : 0;
      
      detailsEl.innerHTML = `
        <div class="member-name">${member.name}</div>
        <div class="detail-row">
          <span class="detail-label">Usrah</span>
          <span class="detail-value">${member.usrahName}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Status</span>
          <span class="detail-value">${member.active ? '✔ Active' : '⚠ Inactive'}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Joined</span>
          <span class="detail-value">${joinDate} (${daysSinceJoin}d ago)</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Overall Attendance</span>
          <span class="detail-value">${rate}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Best Streak</span>
          <span class="detail-value">${member.streak} weeks</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Member Status</span>
          <span class="detail-value">${member.is_member ? '✔ Member' : 'Interested'}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Dev Plan (PDP)</span>
          <span class="detail-value">${member.development_plan ? '✔ On file' : '❌ Not on file'}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Leadership</span>
          <span class="detail-value">${member.leadership ? '★ Yes' : 'No'}</span>
        </div>
        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);">
          <div style="font-size: 11px; font-weight: 700; color: var(--muted); margin-bottom: 8px; text-transform: uppercase;">Growth Gauges</div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div style="text-align: center;">
              <div style="font-size: 12px; color: var(--text); margin-bottom: 8px;">Brotherhood</div>
              <div style="display: flex; align-items: baseline; justify-content: center; gap: 4px;">
                <div style="font-size: 36px; font-weight: 700; color: ${member.brotherhood_rating >= 4 ? '#22c55e' : member.brotherhood_rating === 3 ? '#f59e0b' : member.brotherhood_rating === 2 ? '#fb923c' : '#ef4444'};">${member.brotherhood_rating || 'N/A'}</div>
                <div style="font-size: 12px; color: var(--muted); margin-top: 4px;">/5</div>
              </div>
            </div>
            <div style="text-align: center;">
              <div style="font-size: 12px; color: var(--text); margin-bottom: 8px;">Quran</div>
              <div style="display: flex; align-items: baseline; justify-content: center; gap: 4px;">
                <div style="font-size: 36px; font-weight: 700; color: ${member.quran_progress >= 4 ? '#22c55e' : member.quran_progress === 3 ? '#f59e0b' : member.quran_progress === 2 ? '#fb923c' : '#ef4444'};">${member.quran_progress || 'N/A'}</div>
                <div style="font-size: 12px; color: var(--muted); margin-top: 4px;">/5</div>
              </div>
            </div>
            <div style="text-align: center;">
              <div style="font-size: 12px; color: var(--text); margin-bottom: 8px;">Activism</div>
              <div style="display: flex; align-items: baseline; justify-content: center; gap: 4px;">
                <div style="font-size: 36px; font-weight: 700; color: ${member.activism_rating >= 4 ? '#22c55e' : member.activism_rating === 3 ? '#f59e0b' : member.activism_rating === 2 ? '#fb923c' : '#ef4444'};">${member.activism_rating || 'N/A'}</div>
                <div style="font-size: 12px; color: var(--muted); margin-top: 4px;">/5</div>
              </div>
            </div>
            <div style="text-align: center;">
              <div style="font-size: 12px; color: var(--text); margin-bottom: 8px;">Chapter</div>
              <div style="display: flex; align-items: baseline; justify-content: center; gap: 4px;">
                <div style="font-size: 36px; font-weight: 700; color: ${member.chapter_involvement >= 4 ? '#22c55e' : member.chapter_involvement === 3 ? '#f59e0b' : member.chapter_involvement === 2 ? '#fb923c' : '#ef4444'};">${member.chapter_involvement || 'N/A'}</div>
                <div style="font-size: 12px; color: var(--muted); margin-top: 4px;">/5</div>
              </div>
            </div>
          </div>
        </div>
        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);">
          <div style="font-size: 11px; font-weight: 700; color: var(--muted); margin-bottom: 8px; text-transform: uppercase;">Last 4 Weeks</div>
          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
            ${recentRecords.slice(-4).map((rec, idx) => {
              const symbol = rec.status === 'present' ? '✓' : rec.status === 'excused' ? 'E' : '✗';
              const color = rec.status === 'present' ? '#22c55e' : rec.status === 'excused' ? '#3b82f6' : '#ef4444';
              return `<div style="text-align: center; padding: 8px; background: ${color}20; border: 1px solid ${color}40; border-radius: 6px; font-size: 20px; font-weight: bold; color: ${color};">${symbol}</div>`;
            }).join('')}
          </div>
        </div>
      `;
    }
    
    // ============ DATA INITIALIZATION ============
    // Sample data (fallback when Supabase unavailable).
    const DATA = {
      settings: { windowMonths: 2 },
      usrah: [
        { usrah_id: "u1", usrah_name: "North River", region: "Southeast", naqeeb: "p1" },
        { usrah_id: "u2", usrah_name: "East Grove", region: "Southeast", naqeeb: "p4" },
        { usrah_id: "u3", usrah_name: "Westfield", region: "West", naqeeb: "p7" }
      ],
      people: [
        { person_id: "p1", name: "Aisha Rahman", usrah_id: "u1", active: true, is_member: true, development_plan: true, leadership: true, join_date: "2024-01-15", brotherhood_rating: 4, quran_progress: 3, activism_rating: 5, chapter_involvement: 4 },
        { person_id: "p2", name: "Fatimah Khan", usrah_id: "u1", active: true, is_member: true, development_plan: false, leadership: false, join_date: "2024-11-10", brotherhood_rating: 3, quran_progress: 2, activism_rating: 3, chapter_involvement: 3 },
        { person_id: "p3", name: "Yusuf Malik", usrah_id: "u1", active: true, is_member: true, development_plan: true, leadership: false, join_date: "2023-09-20", brotherhood_rating: 5, quran_progress: 4, activism_rating: 4, chapter_involvement: 5 },
        { person_id: "p4", name: "Ismail Odeh", usrah_id: "u2", active: true, is_member: true, development_plan: true, leadership: true, join_date: "2024-08-05", brotherhood_rating: 5, quran_progress: 5, activism_rating: 5, chapter_involvement: 5 },
        { person_id: "p5", name: "Maryam Said", usrah_id: "u2", active: true, is_member: true, development_plan: false, leadership: false, join_date: "2025-01-12", brotherhood_rating: 2, quran_progress: 3, activism_rating: 2, chapter_involvement: 2 },
        { person_id: "p6", name: "Nadia Idris", usrah_id: "u2", active: false, is_member: false, development_plan: false, leadership: false, join_date: "2024-03-22", brotherhood_rating: 1, quran_progress: 1, activism_rating: 1, chapter_involvement: 1 },
        { person_id: "p7", name: "Omar Saleh", usrah_id: "u3", active: true, is_member: true, development_plan: true, leadership: false, join_date: "2024-10-15", brotherhood_rating: 4, quran_progress: 4, activism_rating: 3, chapter_involvement: 4 },
        { person_id: "p8", name: "Sarah Idris", usrah_id: "u3", active: true, is_member: true, development_plan: true, leadership: true, join_date: "2024-07-18", brotherhood_rating: 5, quran_progress: 5, activism_rating: 4, chapter_involvement: 5 },
        { person_id: "p9", name: "Bilal Karim", usrah_id: "u3", active: true, is_member: true, development_plan: false, leadership: false, join_date: "2024-12-01", brotherhood_rating: 3, quran_progress: 2, activism_rating: 3, chapter_involvement: 3 }
      ],
      weeks: [
        { week_id: "2025-W01", start_date: "2025-01-06", end_date: "2025-01-12" },
        { week_id: "2025-W02", start_date: "2025-01-13", end_date: "2025-01-19" },
        { week_id: "2025-W03", start_date: "2025-01-20", end_date: "2025-01-26" },
        { week_id: "2025-W04", start_date: "2025-01-27", end_date: "2025-02-02" },
        { week_id: "2025-W05", start_date: "2025-02-03", end_date: "2025-02-09" },
        { week_id: "2025-W06", start_date: "2025-02-10", end_date: "2025-02-16" },
        { week_id: "2025-W07", start_date: "2025-02-17", end_date: "2025-02-23" },
        { week_id: "2025-W08", start_date: "2025-02-24", end_date: "2025-03-02" },
        { week_id: "2025-W09", start_date: "2025-03-03", end_date: "2025-03-09" },
        { week_id: "2025-W10", start_date: "2025-03-10", end_date: "2025-03-16" },
        { week_id: "2025-W11", start_date: "2025-03-17", end_date: "2025-03-23" },
        { week_id: "2025-W12", start_date: "2025-03-24", end_date: "2025-03-30" }
      ],
      attendance: [
        { person_id: "p1", week_id: "2025-W09", status: "present", reported_by: "u1", reported_at: "2025-03-04" },
        { person_id: "p1", week_id: "2025-W10", status: "present", reported_by: "u1", reported_at: "2025-03-11" },
        { person_id: "p1", week_id: "2025-W11", status: "absent", reported_by: "u1", reported_at: "2025-03-18" },
        { person_id: "p1", week_id: "2025-W12", status: "present", reported_by: "u1", reported_at: "2025-03-25" },
        { person_id: "p2", week_id: "2025-W09", status: "absent", reported_by: "u1", reported_at: "2025-03-04" },
        { person_id: "p2", week_id: "2025-W10", status: "present", reported_by: "u1", reported_at: "2025-03-11" },
        { person_id: "p2", week_id: "2025-W11", status: "present", reported_by: "u1", reported_at: "2025-03-18" },
        { person_id: "p3", week_id: "2025-W10", status: "excused", reported_by: "u1", reported_at: "2025-03-11" },
        { person_id: "p3", week_id: "2025-W11", status: "present", reported_by: "u1", reported_at: "2025-03-18" },
        { person_id: "p4", week_id: "2025-W09", status: "present", reported_by: "u2", reported_at: "2025-03-04" },
        { person_id: "p4", week_id: "2025-W10", status: "present", reported_by: "u2", reported_at: "2025-03-11" },
        { person_id: "p4", week_id: "2025-W11", status: "present", reported_by: "u2", reported_at: "2025-03-18" },
        { person_id: "p5", week_id: "2025-W09", status: "present", reported_by: "u2", reported_at: "2025-03-04" },
        { person_id: "p5", week_id: "2025-W10", status: "absent", reported_by: "u2", reported_at: "2025-03-11" },
        { person_id: "p5", week_id: "2025-W11", status: "excused", reported_by: "u2", reported_at: "2025-03-18" },
        { person_id: "p7", week_id: "2025-W10", status: "present", reported_by: "u3", reported_at: "2025-03-11" },
        { person_id: "p7", week_id: "2025-W11", status: "present", reported_by: "u3", reported_at: "2025-03-18" },
        { person_id: "p7", week_id: "2025-W12", status: "present", reported_by: "u3", reported_at: "2025-03-25" },
        { person_id: "p8", week_id: "2025-W10", status: "absent", reported_by: "u3", reported_at: "2025-03-11" },
        { person_id: "p8", week_id: "2025-W11", status: "absent", reported_by: "u3", reported_at: "2025-03-18" },
        { person_id: "p9", week_id: "2025-W10", status: "present", reported_by: "u3", reported_at: "2025-03-11" },
        { person_id: "p9", week_id: "2025-W11", status: "present", reported_by: "u3", reported_at: "2025-03-18" },
        { person_id: "p9", week_id: "2025-W12", status: "excused", reported_by: "u3", reported_at: "2025-03-25" }
      ]
    };

    // Derived maps for quick lookups.
    let PEOPLE_BY_ID = new Map(DATA.people.map(p => [p.person_id, p]));
    let USRAH_BY_ID = new Map(DATA.usrah.map(u => [u.usrah_id, u]));

    // ============ SUPABASE INTEGRATION ============
    async function loadDataFromSupabase() {
      try {
        const SUPABASE_URL = 'https://ocjtsdxrhmikrzypfkbq.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9janRzZHhyaG1pa3J6eXBma2JxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYzMzkyNTIsImV4cCI6MjA4MTkxNTI1Mn0.pfJlB37YNRI_3iu76zX_FFiq_ciwVk0qOqpdSbMYVCA';
        const supabase = window.supabaseCreateClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        const [usrahRes, peopleRes, attendanceRes] = await Promise.all([
          supabase.from('usrah').select('*'),
          supabase.from('people').select('*'),
          supabase.from('attendance').select('*')
        ]);
        
        if (usrahRes.error) throw usrahRes.error;
        if (peopleRes.error) throw peopleRes.error;
        if (attendanceRes.error) throw attendanceRes.error;
        
        // Update DATA with Supabase results
        DATA.usrah = usrahRes.data;
        DATA.people = peopleRes.data;
        DATA.attendance = attendanceRes.data;
        
        // Reinitialize lookup maps
        PEOPLE_BY_ID = new Map(DATA.people.map(p => [p.person_id, p]));
        USRAH_BY_ID = new Map(DATA.usrah.map(u => [u.usrah_id, u]));
        
        console.log('✓ Data loaded from Supabase');
        return true;
      } catch (err) {
        console.warn('Supabase connection failed, using fallback data:', err.message);
        return false;
      }
    }

    let visibleWeeks = [];
    let visibleWeekIds = new Set();

    function formatPercent(n) {
      if (Number.isNaN(n)) return "0%";
      return `${Math.round(n * 100)}%`;
    }

    function getRatingDot(rating, size = '18px') {
      const sizeNum = parseInt(size);
      const colors = {
        0: '#999999',  // gray
        1: '#ef4444',  // red
        2: '#fb923c',  // orange
        3: '#fbbf24',  // yellow
        4: '#a3e635',  // lime
        5: '#22c55e'   // green
      };
      const color = colors[rating] || '#999999';
      const r = sizeNum / 2 * 0.7; // 70% of size for circle radius
      return `<svg width="${sizeNum}" height="${sizeNum}" viewBox="0 0 ${sizeNum} ${sizeNum}" style="display: inline-block; vertical-align: middle;"><circle cx="${sizeNum/2}" cy="${sizeNum/2}" r="${r}" fill="${color}"/></svg>`;
    }

    function computeMetrics() {
      const activePeople = DATA.people.filter(p => p.active);
      const recentWeeks = visibleWeeks.slice(-4).map(w => w.week_id);
      const attendance = DATA.attendance.filter(a => visibleWeekIds.has(a.week_id));

      let present = 0;
      let absent = 0;
      attendance.forEach(a => {
        if (a.status === "present") present += 1;
        if (a.status === "absent") absent += 1;
      });
      const overallRate = present + absent === 0 ? 0 : present / (present + absent);

      const completenessPairsExpected = DATA.usrah.length * visibleWeeks.length;
      const usrahWeekReported = new Set(attendance.map(a => `${a.reported_by}_${a.week_id}`));
      const reportingCompleteness = completenessPairsExpected === 0 ? 0 : usrahWeekReported.size / completenessPairsExpected;

      const zeroAttendanceMembers = activePeople.filter(person => {
        const records = attendance.filter(a => a.person_id === person.person_id && recentWeeks.includes(a.week_id));
        const hadPresence = records.some(r => r.status === "present");
        return !hadPresence && recentWeeks.length > 0;
      });

      const streakMembers = activePeople.filter(person => {
        const records = attendance
          .filter(a => a.person_id === person.person_id)
          .sort((a, b) => visibleWeeks.findIndex(w => w.week_id === a.week_id) - visibleWeeks.findIndex(w => w.week_id === b.week_id));
        let best = 0;
        let current = 0;
        visibleWeeks.forEach(w => {
          const record = records.find(r => r.week_id === w.week_id);
          if (record && record.status === "present") {
            current += 1;
            best = Math.max(best, current);
          } else {
            current = 0;
          }
        });
        return best >= 3;
      });

      // Calculate new members in last 6 months
      const sixMonthsAgo = new Date();
      sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
      const newMembers = activePeople.filter(p => {
        if (!p.join_date) return false;
        const joinDate = new Date(p.join_date);
        return joinDate >= sixMonthsAgo;
      }).length;

      return {
        overallRate,
        activeMembers: activePeople.length,
        newMembers,
        usrahCount: DATA.usrah.length,
        reportingCompleteness,
        zeroAttendanceMembers,
        streakMembers
      };
    }

    function getBestStreak(personId) {
      const records = DATA.attendance
        .filter(a => a.person_id === personId && visibleWeekIds.has(a.week_id))
        .reduce((map, r) => (map[r.week_id] = r.status, map), {});
      let best = 0, current = 0;
      visibleWeeks.forEach(w => {
        const status = records[w.week_id];
        if (status === 'present') { current += 1; best = Math.max(best, current); } else { current = 0; }
      });
      return best;
    }

    function getMetricClass(value, type) {
      if (type === 'rate') {
        if (value > 0.8) return 'good';
        if (value < 0.5) return 'bad';
        return 'neutral';
      }
      if (type === 'zero') {
        return value === 0 ? 'good' : 'bad';
      }
      if (type === 'streak') {
        return value > 0 ? 'good' : 'neutral';
      }
      return 'neutral';
    }

    function renderMetrics() {
      const metricsEl = document.getElementById("metrics");
      const m = computeMetrics();
      const overallClass = getMetricClass(m.overallRate, 'rate');
      const reportingClass = getMetricClass(m.reportingCompleteness, 'rate');

      // Build streak leaderboard with medals (top 10)
      const streaks = DATA.people
        .filter(p => p.active)
        .map(p => ({ name: p.name, streak: getBestStreak(p.person_id) }))
        .filter(s => s.streak >= 1)
        .sort((a, b) => b.streak - a.streak)
        .slice(0, 10);
      const medals = ['🥇', '🥈', '🥉'];

      const zeroList = m.zeroAttendanceMembers.slice(0, 5);

      metricsEl.innerHTML = `
        <div class="metrics-table-wrapper">
          <table class="metrics-table">
            <thead>
              <tr><th>Metric</th><th>Value</th></tr>
            </thead>
            <tbody>
              <tr>
                <td>Overall attendance</td>
                <td class="value ${overallClass}">${formatPercent(m.overallRate)}</td>
              </tr>
              <tr>
                <td>Active members</td>
                <td class="value neutral">${m.activeMembers}</td>
              </tr>
              <tr>
                <td>New members (6 mo)</td>
                <td class="value neutral">${m.newMembers}</td>
              </tr>
              <tr>
                <td>Usrahs</td>
                <td class="value neutral">${m.usrahCount}</td>
              </tr>
              <tr>
                <td>Reporting completeness</td>
                <td class="value ${reportingClass}">${formatPercent(m.reportingCompleteness)}</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="leaderboards">
          <div class="leaderboard leaderboard-streaks" aria-label="General Leaderboard">
            <h3 style="cursor: pointer;" onclick="leaderboardMetric = leaderboardMetric === 'streak' ? 'attendance' : (leaderboardMetric === 'attendance' ? 'brotherhood' : 'streak'); renderMetrics();">
              🎮 ${leaderboardMetric === 'streak' ? 'TOP STREAKS' : (leaderboardMetric === 'attendance' ? 'TOP ATTENDANCE' : 'TOP BROTHERHOOD')}
            </h3>
            <div style="font-size: 10px; color: var(--muted); margin: -8px 0 8px; text-align: center;">Click title to toggle metric</div>
            ${(function() {
              let leaders = [];
              const medals = ['🥇', '🥈', '🥉'];
              const medalColors = [
                'linear-gradient(135deg, rgba(212,175,55,0.22), rgba(212,175,55,0.12))',
                'linear-gradient(135deg, rgba(192,192,192,0.22), rgba(192,192,192,0.12))',
                'linear-gradient(135deg, rgba(205,127,50,0.22), rgba(205,127,50,0.12))'
              ];
              const metricColors = { 5: '#22c55e', 4: '#84cc16', 3: '#f59e0b', 2: '#fb923c', 1: '#ef4444' };
              
              if (leaderboardMetric === 'streak') {
                leaders = streaks.slice(0, 10);
                return leaders.length ? leaders.map((s, idx) => {
                  const bgColor = idx < 3 ? medalColors[idx] : 'transparent';
                  const textColor = 'var(--text)';
                  return `
                    <div class="leaderboard-item" style="background: ${bgColor}; color: ${textColor}; font-weight: ${idx < 3 ? '700' : '400'}; border: ${idx < 3 ? '1px solid rgba(0,0,0,0.06)' : '1px solid transparent'};">
                      <span class="lb-name">${medals[idx] || ''}${s.name}</span>
                      <span class="lb-score" style="color: ${textColor}; font-weight: 700;">${s.streak} wks</span>
                    </div>
                  `;
                }).join('') : '<div class="muted">No streaks yet.</div>';
              } else if (leaderboardMetric === 'attendance') {
                leaders = DATA.people.filter(p => p.active)
                  .map(p => ({ name: p.name, rate: getAttendanceRate(p.person_id) }))
                  .sort((a, b) => b.rate - a.rate)
                  .slice(0, 10);
                return leaders.length ? leaders.map((s, idx) => {
                  const bgColor = idx < 3 ? medalColors[idx] : 'transparent';
                  const textColor = 'var(--text)';
                  const rateColor = s.rate >= 0.8 ? '#22c55e' : s.rate >= 0.6 ? '#22d3ee' : s.rate >= 0.4 ? '#f59e0b' : '#ef4444';
                  return `
                    <div class="leaderboard-item" style="background: ${bgColor}; color: ${textColor}; font-weight: ${idx < 3 ? '700' : '400'}; border: ${idx < 3 ? '1px solid rgba(0,0,0,0.06)' : '1px solid transparent'};">
                      <span class="lb-name">${medals[idx] || ''}${s.name}</span>
                      <span class="lb-score" style="color: ${rateColor}; font-weight: 700;">${formatPercent(s.rate)}</span>
                    </div>
                  `;
                }).join('') : '<div class="muted">No data.</div>';
              } else {
                leaders = DATA.people.filter(p => p.active)
                  .map(p => ({ name: p.name, rating: p.brotherhood_rating || 0 }))
                  .sort((a, b) => b.rating - a.rating)
                  .slice(0, 10);
                return leaders.length ? leaders.map((s, idx) => {
                  const bgColor = idx < 3 ? medalColors[idx] : 'transparent';
                  const textColor = 'var(--text)';
                  const metricColor = metricColors[Math.min(5, Math.max(1, s.rating))] || '#999';
                  return `
                    <div class="leaderboard-item" style="background: ${bgColor}; color: ${textColor}; font-weight: ${idx < 3 ? '700' : '400'}; border: ${idx < 3 ? '1px solid rgba(0,0,0,0.06)' : '1px solid transparent'};">
                      <span class="lb-name">${medals[idx] || ''}${s.name}</span>
                      <span class="lb-score" style="color: ${metricColor}; font-weight: 700;">${getRatingDot(s.rating)} ${s.rating} / 5</span>
                    </div>
                  `;
                }).join('') : '<div class="muted">No ratings.</div>';
              }
            })()}
          </div>
          <div class="leaderboard leaderboard-attention" aria-label="Needs Attention">
            <h3>⚠️ ATTENTION NEEDED</h3>
            ${(function() {
              const issues = [];
              // People with 0 attendance in last 3 weeks
              DATA.people.filter(p => p.active).forEach(p => {
                const recentWeeks = visibleWeeks.slice(-3).map(w => w.week_id);
                const records = DATA.attendance.filter(a => a.person_id === p.person_id && recentWeeks.includes(a.week_id));
                const hadPresence = records.some(r => r.status === 'present');
                if (!hadPresence) {
                  issues.push({ name: p.name, issue: '0 in 3 wks' });
                }
              });
              // People without PDP
              DATA.people.filter(p => p.active && !p.development_plan).forEach(p => {
                if (!issues.find(i => i.name === p.name)) {
                  issues.push({ name: p.name, issue: 'No PDP' });
                }
              });
              const list = issues.slice(0, 10);
              return list.length ? list.map(p => `
                <div class="leaderboard-item">
                  <span class="lb-name">${p.name}</span>
                  <span class="lb-score">${p.issue}</span>
                </div>
              `).join('') : '<div class="muted">All good!</div>';
            })()}
          </div>
        </div>
      `;
    }

    const LEADERBOARD_FILTERS = { metric: 'rating', sort: 'desc', search: '' };

    function renderUsrahLeaderboard() {
      const box = document.getElementById('usrah-leaderboard');
      if (!box) return;
      const search = LEADERBOARD_FILTERS.search.toLowerCase();

      // Precompute max members for normalization
      const maxMembers = Math.max(1, ...DATA.usrah.map(u => usrahSummary(u.usrah_id).memberCount));

      const rowsRaw = DATA.usrah.map(u => {
        const s = usrahSummary(u.usrah_id);
        const trendScore = s.trend === '+' ? 1 : s.trend === '-' ? 0.2 : 0.5; // normalize 0..1
        const membersNorm = s.memberCount / maxMembers; // 0..1
        const rating = Math.round(((s.attendanceRate + s.completeness + trendScore + membersNorm) / 4) * 100);
        return {
          id: u.usrah_id,
          name: u.usrah_name,
          metrics: {
            rating,
            attendance: s.attendanceRate,
            completeness: s.completeness,
            members: s.memberCount,
            trend: s.trend
          }
        };
      }).filter(r => !search || r.name.toLowerCase().includes(search));

      const metricKey = ['rating','attendance','completeness','members','trend'].includes(LEADERBOARD_FILTERS.metric) ? LEADERBOARD_FILTERS.metric : 'rating';
      const valForSort = (m) => {
        if (metricKey === 'trend') return m.trend === '+' ? 3 : m.trend === '-' ? 1 : 2;
        return m[metricKey];
      };
      rowsRaw.sort((a, b) => {
        const av = valForSort(a.metrics);
        const bv = valForSort(b.metrics);
        return LEADERBOARD_FILTERS.sort === 'asc' ? av - bv : bv - av;
      });

      // Build table
      const arrow = LEADERBOARD_FILTERS.sort === 'asc' ? '▲' : '▼';
      const clickArrow = usrahTableFilters.ascending ? '▲' : '▼';
      const th = (label, key, showArrow=false) => {
        const isActiveOld = metricKey === key;
        const isActiveNew = usrahTableFilters.column === key;
        const style = isActiveNew ? 'background: rgba(14, 165, 233, 0.2); font-weight: 700; cursor: pointer;' : 'cursor: pointer;';
        return `
        <th style="${style}" onclick="
          if (usrahTableFilters.column === '${key}') {
            if (usrahTableFilters.ascending) {
              usrahTableFilters.ascending = false;
            } else {
              usrahTableFilters.column = null;
            }
          } else {
            usrahTableFilters.column = '${key}';
            usrahTableFilters.ascending = true;
          }
          renderUsrahLeaderboard();
        ">
          <span class="usrah-sort ${isActiveOld ? 'active' : ''}" data-metric="${key}">
            ${label} ${isActiveNew ? clickArrow : (showArrow && isActiveOld ? `<span class="arrow">${arrow}</span>` : '')}
          </span>
        </th>`;
      };

      // Apply usrah table column filter
      if (usrahTableFilters.column) {
        rowsRaw.sort((a, b) => {
          let aVal, bVal;
          if (usrahTableFilters.column === 'name') {
            aVal = a.name;
            bVal = b.name;
            const result = aVal.localeCompare(bVal);
            return usrahTableFilters.ascending ? result : -result;
          } else if (usrahTableFilters.column === 'trend') {
            aVal = a.metrics.trend === '+' ? 3 : a.metrics.trend === '-' ? 1 : 2;
            bVal = b.metrics.trend === '+' ? 3 : b.metrics.trend === '-' ? 1 : 2;
            return usrahTableFilters.ascending ? aVal - bVal : bVal - aVal;
          } else {
            aVal = a.metrics[usrahTableFilters.column];
            bVal = b.metrics[usrahTableFilters.column];
            return usrahTableFilters.ascending ? aVal - bVal : bVal - aVal;
          }
        });
      }
      
      const fmtPct = (n) => `${Math.round(n * 100)}%`;
      const attendanceColor = (rate) => rate >= 0.8 ? '#22c55e' : rate >= 0.6 ? '#22d3ee' : rate >= 0.4 ? '#f59e0b' : '#ef4444';
      const rowsHtml = rowsRaw.map((r, i) => {
        let rowBg = '';
        if (usrahTableFilters.column === 'attendance') {
          rowBg = `background: ${attendanceColor(r.metrics.attendance)}20;`;
        } else if (usrahTableFilters.column === 'trend') {
          const trendColor = r.metrics.trend === '+' ? '#22c55e' : r.metrics.trend === '-' ? '#ef4444' : '#f59e0b';
          rowBg = `background: ${trendColor}20;`;
        }
        
        return `
        <tr style="${rowBg}">
          <td class="rank">${i + 1}</td>
          <td class="name" style="${usrahTableFilters.column === 'name' ? 'background: rgba(14, 165, 233, 0.15);' : ''}">${r.name}</td>
          <td class="val" style="${usrahTableFilters.column === 'rating' ? 'background: rgba(14, 165, 233, 0.15);' : ''}">${r.metrics.rating}</td>
          <td style="${usrahTableFilters.column === 'attendance' ? 'background: rgba(14, 165, 233, 0.15);' : ''}">${fmtPct(r.metrics.attendance)}</td>
          <td style="${usrahTableFilters.column === 'completeness' ? 'background: rgba(14, 165, 233, 0.15);' : ''}">${fmtPct(r.metrics.completeness)}</td>
          <td style="${usrahTableFilters.column === 'members' ? 'background: rgba(14, 165, 233, 0.15);' : ''}">${r.metrics.members}</td>
          <td style="${usrahTableFilters.column === 'trend' ? 'background: rgba(14, 165, 233, 0.15);' : ''}">${r.metrics.trend}</td>
        </tr>
      `;
      }).join('');

      box.innerHTML = `
        <table class="usrah-table" aria-label="Usrah Metrics">
          <thead>
            <tr>
              <th title="Position in leaderboard">Rank</th>
              ${th('Usrah <span style="cursor: help; color: var(--muted); font-size: 12px; font-weight: normal;" title="Usrah group name">ℹ</span>','name')}
              ${th('Rating <span style="cursor: help; color: var(--muted); font-size: 12px; font-weight: normal;" title="Overall performance score">ℹ</span>','rating',true)}
              ${th('Attendance <span style="cursor: help; color: var(--muted); font-size: 12px; font-weight: normal;" title="Attendance rate percentage">ℹ</span>','attendance')}
              ${th('Completeness <span style="cursor: help; color: var(--muted); font-size: 12px; font-weight: normal;" title="Reporting completeness rate">ℹ</span>','completeness')}
              ${th('Members <span style="cursor: help; color: var(--muted); font-size: 12px; font-weight: normal;" title="Number of active members">ℹ</span>','members')}
              ${th('Trend <span style="cursor: help; color: var(--muted); font-size: 12px; font-weight: normal;" title="Attendance trend (+ improving, - declining, = stable)">ℹ</span>','trend')}
            </tr>
          </thead>
          <tbody>
            ${rowsHtml || `<tr><td colspan="7" class="muted">No data yet.</td></tr>`}
          </tbody>
        </table>
      `;

      // Header click handlers to change metric and toggle sort
      box.querySelectorAll('.usrah-sort').forEach(el => {
        el.addEventListener('click', () => {
          const key = el.getAttribute('data-metric');
          if (LEADERBOARD_FILTERS.metric === key) {
            LEADERBOARD_FILTERS.sort = LEADERBOARD_FILTERS.sort === 'asc' ? 'desc' : 'asc';
          } else {
            LEADERBOARD_FILTERS.metric = key;
          }
          renderUsrahLeaderboard();
        });
      });
    }

    function usrahSummary(usrahId) {
      const people = DATA.people.filter(p => p.usrah_id === usrahId && p.active);
      const attendance = DATA.attendance.filter(a => a.reported_by === usrahId && visibleWeekIds.has(a.week_id));

      let present = 0;
      let absent = 0;
      attendance.forEach(a => {
        if (a.status === "present") present += 1;
        if (a.status === "absent") absent += 1;
      });
      const attendanceRate = present + absent === 0 ? 0 : present / (present + absent);

      const completeness = visibleWeeks.length === 0 ? 0 : new Set(attendance.map(a => a.week_id)).size / visibleWeeks.length;

      const recent = visibleWeeks.slice(-4);
      const prior = visibleWeeks.slice(-8, -4);

      const computeRate = weeksSlice => {
        let p = 0, a = 0;
        weeksSlice.forEach(w => {
          DATA.attendance
            .filter(r => r.reported_by === usrahId && r.week_id === w.week_id)
            .forEach(r => {
              if (r.status === "present") p += 1;
              if (r.status === "absent") a += 1;
            });
        });
        return p + a === 0 ? null : p / (p + a);
      };

      const recentRate = computeRate(recent);
      const priorRate = computeRate(prior);
      let trend = "=";
      if (recentRate !== null && priorRate !== null) {
        const delta = (recentRate - priorRate) * 100;
        if (delta >= 5) trend = "+";
        else if (delta <= -5) trend = "-";
      }

      return { attendanceRate, completeness, trend, memberCount: people.length };
    }

    function renderMembersTable() {
      const container = document.getElementById("members-table");
      const searchInput = document.getElementById("members-search");
      if (!container) return;
      
      const infoIcon = (label, tooltip) => `${label} <span style="cursor: help; color: var(--accent); font-size: 16px; font-weight: 700; display: inline-block; margin-left: 4px;" title="${tooltip}" role="img" aria-label="info">ⓘ</span>`;

      let filteredMembers = DATA.people.filter(p => p.active);
      const searchTerm = searchInput?.value.toLowerCase() || '';
      
      if (searchTerm) {
        filteredMembers = filteredMembers.filter(p => 
          p.name.toLowerCase().includes(searchTerm)
        );
      }

      // Get all visible weeks (last 2 months)
      const twoMonthsAgo = new Date();
      twoMonthsAgo.setMonth(twoMonthsAgo.getMonth() - 2);
      const allVisibleWeeks = DATA.weeks
        .filter(w => new Date(w.start_date) >= twoMonthsAgo)
        .sort((a, b) => new Date(a.start_date) - new Date(b.start_date));
      
      // For the main members table, use only 8 weeks for readability
      const twoMonthsAgo2 = new Date();
      twoMonthsAgo2.setMonth(twoMonthsAgo2.getMonth() - 2);
      const recentWeeks = DATA.weeks
        .filter(w => new Date(w.start_date) >= twoMonthsAgo2)
        .sort((a, b) => new Date(a.start_date) - new Date(b.start_date))
        .slice(-8); // Limit to last 8 weeks for table readability

      const rows = filteredMembers.map(member => {
        const usrah = DATA.usrah.find(u => u.usrah_id === member.usrah_id);
        const rate = getAttendanceRate(member.person_id);
        const streak = getBestStreak(member.person_id);
        
        // Get attendance for each week - use ALL visible weeks for the sheet
        const allWeeksAttendance = allVisibleWeeks.map(week => {
          const record = DATA.attendance.find(a => 
            a.person_id === member.person_id && a.week_id === week.week_id
          );
          if (!record) return '';
          if (record.status === 'present') return '✓';
          if (record.status === 'excused') return 'E';
          if (record.status === 'absent') return '✗';
          return '';
        });
        
        // Get attendance for each week - use recent weeks for the table
        const weeklyAttendance = recentWeeks.map(week => {
          const record = DATA.attendance.find(a => 
            a.person_id === member.person_id && a.week_id === week.week_id
          );
          if (!record) return '';
          if (record.status === 'present') return '✓';
          if (record.status === 'excused') return 'E';
          if (record.status === 'absent') return '✗';
          return '';
        });
        
        // Get latest attendance record for this person to extract ratings
        const latestRecord = DATA.attendance
          .filter(a => a.person_id === member.person_id)
          .sort((a, b) => new Date(b.reported_at || '2000-01-01') - new Date(a.reported_at || '2000-01-01'))[0];
        
        return {
          name: member.name,
          usrah: usrah ? usrah.usrah_name : 'Unknown',
          attendance: formatPercent(rate),
          streak: streak,
          weeklyAttendance: weeklyAttendance,
          allWeeksAttendance: allWeeksAttendance,
          allWeeks: allVisibleWeeks,
          brotherhood: latestRecord?.brotherhood || member.brotherhood_rating || 0,
          pdpCompliance: latestRecord?.pdpCompliance || (member.development_plan ? 5 : 0),
          quran: latestRecord?.quran || member.quran_progress || 0,
          activism: latestRecord?.activism || member.activism_rating || 0,
          leadership: latestRecord?.leadership || member.leadership_rating || (member.leadership ? 5 : 0),
          chapter: latestRecord?.chapter || member.chapter_involvement || 0
        };
      });

      // Apply column filter sorting
      if (memberTableFilters.column) {
        rows.sort((a, b) => {
          let aVal, bVal;
          if (memberTableFilters.column === 'name') {
            aVal = a.name;
            bVal = b.name;
            const result = aVal.localeCompare(bVal);
            return memberTableFilters.ascending ? result : -result;
          } else if (memberTableFilters.column === 'usrah') {
            aVal = a.usrah;
            bVal = b.usrah;
            const result = aVal.localeCompare(bVal);
            return memberTableFilters.ascending ? result : -result;
          } else if (memberTableFilters.column === 'attendance') {
            aVal = parseFloat(a.attendance);
            bVal = parseFloat(b.attendance);
            return memberTableFilters.ascending ? aVal - bVal : bVal - aVal;
          } else if (memberTableFilters.column === 'streak') {
            return memberTableFilters.ascending ? a.streak - b.streak : b.streak - a.streak;
          } else if (['brotherhood', 'pdpCompliance', 'quran', 'activism', 'leadership', 'chapter'].includes(memberTableFilters.column)) {
            aVal = a[memberTableFilters.column];
            bVal = b[memberTableFilters.column];
            return memberTableFilters.ascending ? aVal - bVal : bVal - aVal;
          }
          return 0;
        });
      }
      
      const makeClickable = (col, extraStyle = '') => `style="cursor: pointer; user-select: none; ${memberTableFilters.column === col ? 'background: rgba(14, 165, 233, 0.2); font-weight: 700;' : ''} ${extraStyle}" onclick="
        if (memberTableFilters.column === '${col}') {
          if (memberTableFilters.ascending) {
            memberTableFilters.ascending = false;
          } else {
            memberTableFilters.column = null;
          }
        } else {
          memberTableFilters.column = '${col}';
          memberTableFilters.ascending = true;
        }
        renderMembersTable();
      "`;      
      // Build week-by-week attendance sheet - show ALL weeks for last 2 months
      const attendanceSheet = `
        <div style="margin-bottom: 20px; padding: 16px; background: var(--surface); border: 1px solid var(--border); border-radius: 8px;">
          <h4 style="margin: 0 0 12px; font-size: 14px; color: var(--accent);">📊 ATTENDANCE (Last 2 Months)</h4>
          <div style="overflow-x: auto;">
            <table style="font-size: 11px; width: 100%; border-collapse: collapse; margin: 0;">
              <thead>
                <tr>
                  <th style="text-align: left; padding: 8px; font-size: 11px; font-weight: 600; position: sticky; left: 0; background: var(--summary-bg); z-index: 2; border: 1px solid var(--border);">Member</th>
                  ${allVisibleWeeks.map(w => `<th style="padding: 6px 4px; font-size: 9px; font-weight: 600; text-align: center; min-width: 32px; background: var(--summary-bg); border: 1px solid var(--border); white-space: nowrap;">W${w.week_id.split('-W')[1]}</th>`).join('')}
                </tr>
              </thead>
              <tbody>
                ${rows.map(row => {
                  const cellsHtml = row.allWeeksAttendance.map(att => {
                    let bgColor = '#1a1a2e';
                    let symbol = '-';
                    if (att === '✓') { bgColor = '#22c55e'; symbol = '✓'; }
                    else if (att === '✗') { bgColor = '#ef4444'; symbol = '✗'; }
                    else if (att === 'E') { bgColor = '#3b82f6'; symbol = 'E'; }
                    return `<td style="text-align: center; padding: 6px 2px; background: ${bgColor}; color: white; font-weight: bold; border: 1px solid var(--bg); min-width: 32px;">${symbol}</td>`;
                  }).join('');
                  return `
                    <tr>
                      <td style="padding: 6px 8px; font-size: 11px; font-weight: 600; position: sticky; left: 0; background: var(--surface); border-right: 2px solid var(--border); border-bottom: 1px solid var(--border); z-index: 1; white-space: nowrap;">${row.name.split(' ')[0]}</td>
                      ${cellsHtml}
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;
      
      // Build attendance roster chart - all members, last 8 weeks
      const last8Weeks = DATA.weeks
        .filter(w => new Date(w.start_date) >= twoMonthsAgo)
        .sort((a, b) => new Date(a.start_date) - new Date(b.start_date))
        .slice(-8);

      const rosterChartHtml = `
        <div style="margin-bottom: 24px; padding: 16px; background: var(--surface); border: 1px solid var(--border); border-radius: 8px;">
          <h4 style="margin: 0 0 12px; font-size: 14px; color: var(--accent);">📋 ATTENDANCE ROSTER (Last 8 Weeks)</h4>
          <div style="overflow-x: auto;">
            <table style="font-size: 11px; width: 100%; border-collapse: collapse; margin: 0;">
              <thead>
                <tr>
                  <th style="text-align: left; padding: 8px; font-size: 11px; font-weight: 600; position: sticky; left: 0; background: var(--summary-bg); z-index: 2; border: 1px solid var(--border); min-width: 140px;">Member</th>
                  ${last8Weeks.map(w => `<th style="padding: 6px 4px; font-size: 9px; font-weight: 600; text-align: center; min-width: 28px; background: var(--summary-bg); border: 1px solid var(--border); white-space: nowrap;">W${w.week_id.split('-W')[1]}</th>`).join('')}
                </tr>
              </thead>
              <tbody>
                ${filteredMembers.map(member => {
                  const cellsHtml = last8Weeks.map(week => {
                    const attendance = DATA.attendance.find(a => a.person_id === member.person_id && a.week_id === week.week_id);
                    let bgColor = '#1a1a2e';
                    let symbol = '-';
                    if (attendance?.status === 'present') { bgColor = '#22c55e'; symbol = '✓'; }
                    else if (attendance?.status === 'absent') { bgColor = '#ef4444'; symbol = '✗'; }
                    else if (attendance?.status === 'excused') { bgColor = '#3b82f6'; symbol = 'E'; }
                    return `<td style="text-align: center; padding: 6px 2px; background: ${bgColor}; color: white; font-weight: bold; border: 1px solid var(--bg); min-width: 28px; cursor: default;" title="${symbol}">${symbol}</td>`;
                  }).join('');
                  return `
                    <tr>
                      <td style="padding: 6px 8px; font-size: 11px; font-weight: 600; position: sticky; left: 0; background: var(--surface); border-right: 2px solid var(--border); border-bottom: 1px solid var(--border); z-index: 1; white-space: nowrap;">${member.name.split(' ')[0]}</td>
                      ${cellsHtml}
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;
      
      const html = `
        ${rosterChartHtml}
        <table style="font-size: 13px;">
          <thead>
            <tr>
              <th rowspan="1" ${makeClickable('name', 'vertical-align: bottom;')}>${infoIcon('Name', 'Full name of the member')}</th>
              <th rowspan="1" ${makeClickable('usrah', 'vertical-align: bottom;')}>${infoIcon('Usrah', 'Member\'s usrah group')}</th>
              ${recentWeeks.map(w => `<th style="font-size: 10px; padding: 4px;" title="Week ${w.week_id.split('-W')[1]}">W${w.week_id.split('-W')[1]}</th>`).join('')}
              <th ${makeClickable('attendance', 'vertical-align: bottom;')}>${infoIcon('Attend %', 'Attendance percentage over selected period')} ${memberTableFilters.column === 'attendance' ? (memberTableFilters.ascending ? '▲' : '▼') : ''}</th>
              <th ${makeClickable('streak', 'vertical-align: bottom;')}>${infoIcon('Streak', 'Consecutive weeks present')} ${memberTableFilters.column === 'streak' ? (memberTableFilters.ascending ? '▲' : '▼') : ''}</th>
              <th ${makeClickable('brotherhood', 'font-size: 11px; text-align: center; min-width: 54px;')}>${infoIcon('Broth', 'Brotherhood rating (1-5)')} ${memberTableFilters.column === 'brotherhood' ? (memberTableFilters.ascending ? '▲' : '▼') : ''}</th>
              <th ${makeClickable('pdpCompliance', 'font-size: 11px;')}>${infoIcon('PDP', 'Personal Development Plan status')} ${memberTableFilters.column === 'pdpCompliance' ? (memberTableFilters.ascending ? '▲' : '▼') : ''}</th>
              <th ${makeClickable('quran', 'font-size: 11px;')}>${infoIcon('Quran', 'Qur\'an study progress (1-5)')} ${memberTableFilters.column === 'quran' ? (memberTableFilters.ascending ? '▲' : '▼') : ''}</th>
              <th ${makeClickable('activism', 'font-size: 11px;')}>${infoIcon('Activ', 'Activism involvement rating (1-5)')} ${memberTableFilters.column === 'activism' ? (memberTableFilters.ascending ? '▲' : '▼') : ''}</th>
              <th ${makeClickable('leadership', 'font-size: 11px;')}>${infoIcon('Lead', 'Leadership capability (1-5)')} ${memberTableFilters.column === 'leadership' ? (memberTableFilters.ascending ? '▲' : '▼') : ''}</th>
              <th ${makeClickable('chapter', 'font-size: 11px;')}>${infoIcon('Chap', 'Chapter involvement (1-5)')} ${memberTableFilters.column === 'chapter' ? (memberTableFilters.ascending ? '▲' : '▼') : ''}</th>
            </tr>
          </thead>
          <tbody>
            ${rows.map(row => {
              let rowBg = '';
              if (memberTableFilters.column === 'attendance') {
                const rate = parseFloat(row.attendance) / 100;
                const color = rate >= 0.8 ? '#22c55e' : rate >= 0.6 ? '#22d3ee' : rate >= 0.4 ? '#f59e0b' : '#ef4444';
                rowBg = `background: ${color}15;`;
              } else if (memberTableFilters.column === 'brotherhood' || memberTableFilters.column === 'quran' || memberTableFilters.column === 'activism' || memberTableFilters.column === 'chapter') {
                const rating = row[memberTableFilters.column];
                const ratingColors = { 5: '#22c55e', 4: '#84cc16', 3: '#f59e0b', 2: '#fb923c', 1: '#ef4444' };
                const color = ratingColors[Math.min(5, Math.max(1, rating))] || '#999';
                rowBg = `background: ${color}15;`;
              } else if (memberTableFilters.column === 'pdpCompliance') {
                const hasCompliance = row.pdpCompliance > 0;
                rowBg = hasCompliance ? 'background: #22c55e15;' : 'background: #ef444415;';
              }
              
              return `
              <tr style="${rowBg}">
                <td style="font-weight: 600; ${memberTableFilters.column === 'name' ? 'background: rgba(14, 165, 233, 0.15);' : ''}">${row.name}</td>
                <td style="${memberTableFilters.column === 'usrah' ? 'background: rgba(14, 165, 233, 0.15);' : ''}">${row.usrah}</td>
                ${row.weeklyAttendance.map(att => {
                  let color = '';
                  if (att === '✓') color = 'color: #2e7d32; font-weight: bold;';
                  else if (att === '✗') color = 'color: #d32f2f; font-weight: bold;';
                  else if (att === 'E') color = 'color: #1976d2; font-weight: bold;';
                  return `<td style="text-align: center; ${color}">${att}</td>`;
                }).join('')}
                <td style="${memberTableFilters.column === 'attendance' ? 'background: rgba(14, 165, 233, 0.15);' : ''}">${row.attendance}</td>
                <td style="${memberTableFilters.column === 'streak' ? 'background: rgba(14, 165, 233, 0.15);' : ''}">${row.streak}w</td>
                <td style="text-align: center; font-size: 28px; ${memberTableFilters.column === 'brotherhood' ? 'background: rgba(14, 165, 233, 0.15);' : ''}">${getRatingDot(row.brotherhood, '48px')}</td>
                <td style="text-align: center; font-size: 28px; ${memberTableFilters.column === 'pdpCompliance' ? 'background: rgba(14, 165, 233, 0.15);' : ''}">${getRatingDot(row.pdpCompliance, '48px')}</td>
                <td style="text-align: center; font-size: 28px; ${memberTableFilters.column === 'quran' ? 'background: rgba(14, 165, 233, 0.15);' : ''}">${getRatingDot(row.quran, '48px')}</td>
                <td style="text-align: center; font-size: 28px; ${memberTableFilters.column === 'activism' ? 'background: rgba(14, 165, 233, 0.15);' : ''}">${getRatingDot(row.activism, '48px')}</td>
                <td style="text-align: center; font-size: 28px; ${memberTableFilters.column === 'leadership' ? 'background: rgba(14, 165, 233, 0.15);' : ''}">${getRatingDot(row.leadership, '48px')}</td>
                <td style="text-align: center; font-size: 28px; ${memberTableFilters.column === 'chapter' ? 'background: rgba(14, 165, 233, 0.15);' : ''}">${getRatingDot(row.chapter, '48px')}</td>
              </tr>
            `;
            }).join('')}
          </tbody>
        </table>
      `;

      container.innerHTML = html;
    }

    function initWarnings() {
      const warning = document.getElementById("warning");
      if (!DATA.weeks.length) {
        warning.style.display = "block";
        warning.textContent = "Weeks sheet is empty. Define weeks to track reporting completeness.";
      } else {
        warning.style.display = "none";
      }
    }

    document.addEventListener("DOMContentLoaded", async () => {
      // Try to load from Supabase, fall back to hardcoded data
      const loaded = await loadDataFromSupabase();
      
      // Recalculate time-based variables after data loads
      const latestWeekEnd = DATA.weeks.reduce((latest, week) => {
        const end = new Date(week.end_date);
        return end > latest ? end : latest;
      }, new Date(0));
      const cutoffDate = new Date(latestWeekEnd);
      cutoffDate.setMonth(cutoffDate.getMonth() - DATA.settings.windowMonths);
      visibleWeeks = DATA.weeks.filter(week => new Date(week.end_date) >= cutoffDate);
      visibleWeekIds = new Set(visibleWeeks.map(w => w.week_id));
      
      renderMetrics();
      renderUsrahLeaderboard();
      renderD3Visualization();
      renderMembersTable();
      
      // Members table search
      document.getElementById('members-search')?.addEventListener('input', () => {
        renderMembersTable();
      });
      
      const syncOptionHighlight = (selector) => {
        document.querySelectorAll(selector).forEach(rb => {
          const label = rb.closest('.option-btn');
          if (label) label.classList.toggle('is-active', rb.checked);
        });
      };

      // Group by radios (single select)
      document.querySelectorAll('.viz-group-rb').forEach(rb => {
        rb.addEventListener('change', (e) => {
          if (!e.target.checked) return;
          playSound('ach');
          vizSettings.groupBy = new Set([e.target.value]);
          syncOptionHighlight('.viz-group-rb');
          renderD3Visualization();
        });
      });
      
      // Color by radios (single column)
      document.querySelectorAll('.viz-color-rb').forEach(rb => {
        rb.addEventListener('change', (e) => {
          if (!e.target.checked) return;
          playSound('ach');
          vizSettings.colorBy = e.target.value;
          syncOptionHighlight('.viz-color-rb');
          renderD3Visualization();
        });
      });

      syncOptionHighlight('.viz-group-rb');
      syncOptionHighlight('.viz-color-rb');
    });
  </script>
</body>
</html>
