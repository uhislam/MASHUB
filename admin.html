<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - MAS Houston Tarbiya Health</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.0/+esm';
    window.supabaseCreateClient = createClient;
  </script>
  <style>
    :root {
      --accent: #22d3ee;
      --border: #233045;
      --text: #e5e7eb;
      --muted: #94a3b8;
      --bg: #0b1120;
      --surface: #0f172a;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background: radial-gradient(1200px 600px at 50% -200px, #0b1120 0%, #050b16 100%);
      color: var(--text);
      padding: 20px;
      min-height: 100vh;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    h1 {
      font-family: 'Press Start 2P', cursive;
      font-size: 28px;
      color: var(--accent);
      text-align: center;
      margin: 0 0 30px;
      letter-spacing: 2px;
    }
    .nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }
    .nav a {
      color: var(--accent);
      text-decoration: none;
      font-weight: 700;
      padding: 10px 20px;
      border: 2px solid var(--accent);
      border-radius: 4px;
      transition: all 0.3s;
    }
    .nav a:hover {
      background: var(--accent);
      color: #0b1120;
    }
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid var(--border);
      overflow-x: auto;
    }
    .tab {
      padding: 12px 24px;
      background: var(--surface);
      border: 2px solid var(--border);
      border-bottom: none;
      color: var(--text);
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      white-space: nowrap;
    }
    .tab:hover {
      background: rgba(34, 211, 238, 0.1);
    }
    .tab.active {
      background: var(--accent);
      color: #0b1120;
      border-color: var(--accent);
    }
    .tab-content {
      display: none;
      background: var(--surface);
      border: 2px solid var(--border);
      border-radius: 8px;
      padding: 24px;
      margin-bottom: 20px;
    }
    .tab-content.active {
      display: block;
    }
    .section {
      margin-bottom: 30px;
    }
    .section h2 {
      color: var(--accent);
      font-size: 20px;
      margin: 0 0 16px;
    }
    .form-group {
      margin-bottom: 16px;
    }
    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      font-size: 14px;
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px 12px;
      background: #0b1225;
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text);
      font-family: inherit;
      font-size: 14px;
    }
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 8px rgba(34, 211, 238, 0.3);
    }
    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }
    .btn {
      padding: 10px 20px;
      background: var(--accent);
      color: #0b1120;
      border: 2px solid var(--accent);
      border-radius: 4px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 14px;
    }
    .btn:hover {
      background: transparent;
      color: var(--accent);
    }
    .btn-danger {
      background: #ef4444;
      border-color: #ef4444;
      color: white;
    }
    .btn-danger:hover {
      background: transparent;
      color: #ef4444;
    }
    .btn-secondary {
      background: var(--surface);
      border-color: var(--border);
      color: var(--text);
    }
    .btn-secondary:hover {
      background: rgba(34, 211, 238, 0.1);
      border-color: var(--accent);
    }
    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
    }
    .data-table th,
    .data-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    .data-table th {
      background: rgba(34, 211, 238, 0.1);
      font-weight: 700;
      color: var(--accent);
    }
    .data-table tr:hover {
      background: rgba(34, 211, 238, 0.05);
    }
    .actions {
      display: flex;
      gap: 8px;
    }
    .actions button {
      padding: 6px 12px;
      font-size: 12px;
    }
    .success {
      color: #22c55e;
      background: rgba(34, 197, 94, 0.1);
      padding: 12px 16px;
      border-radius: 4px;
      margin-top: 16px;
      border: 1px solid #22c55e;
    }
    .error {
      color: #ef4444;
      background: rgba(239, 68, 68, 0.1);
      padding: 12px 16px;
      border-radius: 4px;
      margin-top: 16px;
      border: 1px solid #ef4444;
    }
    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .checkbox-group input[type="checkbox"] {
      width: auto;
      cursor: pointer;
    }
    .export-import {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="nav">
      <a href="index.html">‚Üê Back to Dashboard</a>
      <h1>ADMIN PANEL</h1>
      <div></div>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="usrahs">Usrahs</div>
      <div class="tab" data-tab="members">Members</div>
      <div class="tab" data-tab="weeks">Weeks</div>
      <div class="tab" data-tab="attendance">Attendance</div>
      <div class="tab" data-tab="settings">Settings</div>
      <div class="tab" data-tab="data">Import/Export</div>
    </div>

    <!-- Usrahs Tab -->
    <div class="tab-content active" id="usrahs">
      <div class="section">
        <h2>Add New Usrah</h2>
        <form id="usrah-form">
          <div class="form-row">
            <div class="form-group">
              <label>Usrah Name *</label>
              <input type="text" id="usrah-name" required>
            </div>
            <div class="form-group">
              <label>Submission Code *</label>
              <input type="text" id="usrah-code" placeholder="e.g., NR-8432" required>
            </div>
          </div>
          <button type="submit" class="btn">Add Usrah</button>
        </form>
        <div id="usrah-message"></div>
      </div>

      <div class="section">
        <h2>Existing Usrahs</h2>
        <table class="data-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>Submission Code</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="usrah-list"></tbody>
        </table>
      </div>
    </div>

    <!-- Members Tab -->
    <div class="tab-content" id="members">
      <div class="section">
        <h2>Add New Member</h2>
        <form id="member-form">
          <div class="form-row">
            <div class="form-group">
              <label>Name *</label>
              <input type="text" id="member-name" required>
            </div>
            <div class="form-group">
              <label>Usrah *</label>
              <select id="member-usrah" required></select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <div class="checkbox-group">
                <input type="checkbox" id="member-active" checked>
                <label for="member-active">Active</label>
              </div>
            </div>
            <div class="form-group">
              <div class="checkbox-group">
                <input type="checkbox" id="member-is-member">
                <label for="member-is-member">MAS Member</label>
              </div>
            </div>
            <div class="form-group">
              <div class="checkbox-group">
                <input type="checkbox" id="member-dev-plan">
                <label for="member-dev-plan">Has Dev Plan</label>
              </div>
            </div>
            <div class="form-group">
              <div class="checkbox-group">
                <input type="checkbox" id="member-leadership">
                <label for="member-leadership">Leadership</label>
              </div>
            </div>
          </div>
          <button type="submit" class="btn">Add Member</button>
        </form>
        <div id="member-message"></div>
      </div>

      <div class="section">
        <h2>Existing Members</h2>
        <table class="data-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>Usrah</th>
              <th>Active</th>
              <th>Member</th>
              <th>Dev Plan</th>
              <th>Leadership</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="member-list"></tbody>
        </table>
      </div>
    </div>

    <!-- Weeks Tab -->
    <div class="tab-content" id="weeks">
      <div class="section">
        <h2>Add New Week</h2>
        <form id="week-form">
          <div class="form-row">
            <div class="form-group">
              <label>Week ID *</label>
              <input type="text" id="week-id" placeholder="e.g., 2025-W13" required>
            </div>
            <div class="form-group">
              <label>Start Date *</label>
              <input type="date" id="week-start" required>
            </div>
            <div class="form-group">
              <label>End Date *</label>
              <input type="date" id="week-end" required>
            </div>
          </div>
          <button type="submit" class="btn">Add Week</button>
        </form>
        <div id="week-message"></div>
      </div>

      <div class="section">
        <h2>Existing Weeks</h2>
        <table class="data-table">
          <thead>
            <tr>
              <th>Week ID</th>
              <th>Start Date</th>
              <th>End Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="week-list"></tbody>
        </table>
      </div>
    </div>

    <!-- Attendance Tab -->
    <div class="tab-content" id="attendance">
      <div class="section">
        <h2>Add Attendance Record</h2>
        <form id="attendance-form">
          <div class="form-row">
            <div class="form-group">
              <label>Member *</label>
              <select id="attendance-person" required></select>
            </div>
            <div class="form-group">
              <label>Week *</label>
              <select id="attendance-week" required></select>
            </div>
            <div class="form-group">
              <label>Status *</label>
              <select id="attendance-status" required>
                <option value="present">Present</option>
                <option value="absent">Absent</option>
                <option value="excused">Excused</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Brotherhood Rating (1-5)</label>
              <input type="number" id="attendance-brotherhood" min="1" max="5" value="3">
            </div>
            <div class="form-group">
              <label>Service Rating (1-5)</label>
              <input type="number" id="attendance-service" min="1" max="5" value="3">
            </div>
            <div class="form-group">
              <label>Curriculum Rating (1-5)</label>
              <input type="number" id="attendance-curriculum" min="1" max="5" value="3">
            </div>
          </div>
          <button type="submit" class="btn">Add Attendance Record</button>
        </form>
        <div id="attendance-message"></div>
      </div>

      <div class="section">
        <h2>Existing Attendance Records</h2>
        <div style="margin-bottom: 16px;">
          <input type="text" id="attendance-search" placeholder="Search by name or week..." style="padding: 10px; width: 300px; background: #0b1225; border: 1px solid var(--border); border-radius: 4px; color: var(--text);">
        </div>
        <table class="data-table">
          <thead>
            <tr>
              <th>Member</th>
              <th>Week</th>
              <th>Status</th>
              <th>Brotherhood</th>
              <th>Service</th>
              <th>Curriculum</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="attendance-list"></tbody>
        </table>
      </div>
    </div>

    <!-- Settings Tab -->
    <div class="tab-content" id="settings">
      <div class="section">
        <h2>Dashboard Settings</h2>
        <form id="settings-form">
          <div class="form-group">
            <label>Window Months (for visible weeks)</label>
            <input type="number" id="settings-window" min="1" max="12" value="2">
            <small style="display: block; margin-top: 4px; color: var(--muted);">Number of months to display in the attendance view</small>
          </div>
          <div class="form-group">
            <div class="checkbox-group">
              <input type="checkbox" id="settings-google-sheets">
              <label for="settings-google-sheets">Enable Google Sheets Integration</label>
            </div>
          </div>
          <button type="submit" class="btn">Save Settings</button>
        </form>
        <div id="settings-message"></div>
      </div>
    </div>

    <!-- Import/Export Tab -->
    <div class="tab-content" id="data">
      <div class="section">
        <h2>Export Data</h2>
        <p style="color: var(--muted); margin-bottom: 16px;">Download all data as JSON file for backup</p>
        <button class="btn" onclick="exportData()">üì• Export All Data</button>
      </div>

      <div class="section">
        <h2>Import Data</h2>
        <p style="color: var(--muted); margin-bottom: 16px;">Upload a JSON file to restore data</p>
        <input type="file" id="import-file" accept=".json" style="margin-bottom: 16px;">
        <button class="btn" onclick="importData()">üì§ Import Data</button>
        <div id="import-message"></div>
      </div>

      <div class="section">
        <h2>Reset Data</h2>
        <p style="color: #ef4444; margin-bottom: 16px;">‚ö†Ô∏è Warning: This will delete all data and restore sample data. This action cannot be undone!</p>
        <button class="btn btn-danger" onclick="resetData()">üîÑ Reset to Sample Data</button>
      </div>
    </div>
  </div>

  <script>
    // ============ SUPABASE INITIALIZATION ============
    const SUPABASE_URL = 'https://ocjtsdxrhmikrzypfkbq.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9janRzZHhyaG1pa3J6eXBma2JxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYzMzkyNTIsImV4cCI6MjA4MTkxNTI1Mn0.pfJlB37YNRI_3iu76zX_FFiq_ciwVk0qOqpdSbMYVCA';
    
    let supabase;
    let DATA = {
      settings: { windowMonths: 2, USE_GOOGLE_SHEETS: false },
      usrah: [],
      people: [],
      weeks: [],
      attendance: []
    };

    async function initSupabase() {
      supabase = window.supabaseCreateClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      await loadDataFromSupabase();
    }

    async function loadDataFromSupabase() {
      try {
        const [usrahRes, peopleRes, weeksRes, attendanceRes] = await Promise.all([
          supabase.from('usrah').select('*'),
          supabase.from('people').select('*'),
          supabase.from('weeks').select('*'),
          supabase.from('attendance').select('*')
        ]);

        if (usrahRes.data) DATA.usrah = usrahRes.data;
        if (peopleRes.data) DATA.people = peopleRes.data;
        if (weeksRes.data) DATA.weeks = weeksRes.data;
        if (attendanceRes.data) DATA.attendance = attendanceRes.data;

        console.log('‚úì Data loaded from Supabase');
        return true;
      } catch (err) {
        console.warn('Supabase error:', err.message);
        return false;
      }
    }

    function showMessage(elementId, message, isError = false) {
      const el = document.getElementById(elementId);
      el.innerHTML = `<div class="${isError ? 'error' : 'success'}">${message}</div>`;
      setTimeout(() => el.innerHTML = '', 3000);
    }

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab).classList.add('active');
      });
    });

    // USRAHS
    function renderUsrahs() {
      const tbody = document.getElementById('usrah-list');
      tbody.innerHTML = DATA.usrah.map(u => `
        <tr>
          <td>${u.usrah_id}</td>
          <td>${u.usrah_name}</td>
          <td>${u.submission_code}</td>
          <td class="actions">
            <button class="btn btn-secondary" onclick="editUsrah('${u.usrah_id}')">Edit</button>
            <button class="btn btn-danger" onclick="deleteUsrah('${u.usrah_id}')">Delete</button>
          </td>
        </tr>
      `).join('');
      updateUsrahDropdowns();
    }

    function updateUsrahDropdowns() {
      const select = document.getElementById('member-usrah');
      select.innerHTML = DATA.usrah.map(u => 
        `<option value="${u.usrah_id}">${u.usrah_name}</option>`
      ).join('');
    }

    document.getElementById('usrah-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('usrah-name').value;
      const code = document.getElementById('usrah-code').value;
      
      try {
        const { data, error } = await supabase.from('usrah').insert([
          { usrah_name: name, submission_code: code }
        ]);
        if (error) throw error;
        
        await loadDataFromSupabase();
        renderUsrahs();
        showMessage('usrah-message', '‚úì Usrah added successfully!');
        e.target.reset();
      } catch (err) {
        showMessage('usrah-message', 'Error: ' + err.message, true);
      }
    });

    function deleteUsrah(id) {
      if (confirm('Delete this usrah? Members will remain but lose their usrah association.')) {
        supabase.from('usrah').delete().eq('usrah_id', id).then(() => {
          loadDataFromSupabase().then(() => {
            renderUsrahs();
            showMessage('usrah-message', '‚úì Usrah deleted');
          });
        });
      }
    }

    // MEMBERS
    function renderMembers() {
      const tbody = document.getElementById('member-list');
      tbody.innerHTML = DATA.people.map(p => {
        const usrah = DATA.usrah.find(u => u.usrah_id === p.usrah_id);
        return `
          <tr>
            <td>${p.person_id}</td>
            <td>${p.name}</td>
            <td>${usrah ? usrah.usrah_name : 'N/A'}</td>
            <td>${p.active ? '‚úî' : ''}</td>
            <td>${p.is_member ? '‚úî' : ''}</td>
            <td>${p.development_plan ? '‚úî' : ''}</td>
            <td>${p.leadership ? '‚úî' : ''}</td>
            <td class="actions">
              <button class="btn btn-secondary" onclick="editMember('${p.person_id}')">Edit</button>
              <button class="btn btn-danger" onclick="deleteMember('${p.person_id}')">Delete</button>
            </td>
          </tr>
        `;
      }).join('');
      updateMemberDropdowns();
    }

    function updateMemberDropdowns() {
      const select = document.getElementById('attendance-person');
      select.innerHTML = DATA.people.map(p => 
        `<option value="${p.person_id}">${p.name}</option>`
      ).join('');
    }

    document.getElementById('member-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      try {
        const { data, error } = await supabase.from('people').insert([{
          name: document.getElementById('member-name').value,
          usrah_id: document.getElementById('member-usrah').value,
          active: document.getElementById('member-active').checked,
          is_member: document.getElementById('member-is-member').checked,
          development_plan: document.getElementById('member-dev-plan').checked,
          leadership: document.getElementById('member-leadership').checked
        }]);
        if (error) throw error;
        
        await loadDataFromSupabase();
        renderMembers();
        showMessage('member-message', '‚úì Member added successfully!');
        e.target.reset();
        document.getElementById('member-active').checked = true;
      } catch (err) {
        showMessage('member-message', 'Error: ' + err.message, true);
      }
    });

    function deleteMember(id) {
      if (confirm('Delete this member? Their attendance records will also be removed.')) {
        supabase.from('people').delete().eq('person_id', id).then(() => {
          supabase.from('attendance').delete().eq('person_id', id).then(() => {
            loadDataFromSupabase().then(() => {
              renderMembers();
              renderAttendance();
              showMessage('member-message', '‚úì Member deleted');
            });
          });
        });
      }
    }

    // WEEKS
    function renderWeeks() {
      const tbody = document.getElementById('week-list');
      tbody.innerHTML = DATA.weeks.map(w => `
        <tr>
          <td>${w.week_id}</td>
          <td>${w.start_date}</td>
          <td>${w.end_date}</td>
          <td class="actions">
            <button class="btn btn-danger" onclick="deleteWeek('${w.week_id}')">Delete</button>
          </td>
        </tr>
      `).join('');
      updateWeekDropdowns();
    }

    function updateWeekDropdowns() {
      const select = document.getElementById('attendance-week');
      select.innerHTML = DATA.weeks.map(w => 
        `<option value="${w.week_id}">${w.week_id} (${w.start_date})</option>`
      ).join('');
    }

    document.getElementById('week-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      try {
        const { data, error } = await supabase.from('weeks').insert([{
          week_id: document.getElementById('week-id').value,
          start_date: document.getElementById('week-start').value,
          end_date: document.getElementById('week-end').value
        }]);
        if (error) throw error;
        
        await loadDataFromSupabase();
        renderWeeks();
        showMessage('week-message', '‚úì Week added successfully!');
        e.target.reset();
      } catch (err) {
        showMessage('week-message', 'Error: ' + err.message, true);
      }
    });

    function deleteWeek(id) {
      if (confirm('Delete this week? Attendance records for this week will also be removed.')) {
        supabase.from('weeks').delete().eq('week_id', id).then(() => {
          supabase.from('attendance').delete().eq('week_id', id).then(() => {
            loadDataFromSupabase().then(() => {
              renderWeeks();
              renderAttendance();
              showMessage('week-message', '‚úì Week deleted');
            });
          });
        });
      }
    }

    // ATTENDANCE
    function renderAttendance() {
      const tbody = document.getElementById('attendance-list');
      const search = document.getElementById('attendance-search')?.value.toLowerCase() || '';
      
      let records = DATA.attendance.map(a => {
        const person = DATA.people.find(p => p.person_id === a.person_id);
        return { ...a, personName: person ? person.name : 'Unknown' };
      });

      if (search) {
        records = records.filter(r => 
          r.personName.toLowerCase().includes(search) || 
          r.week_id.toLowerCase().includes(search)
        );
      }

      tbody.innerHTML = records.map((a) => `
        <tr>
          <td>${a.personName}</td>
          <td>${a.week_id}</td>
          <td>${a.status}</td>
          <td>${a.brotherhood_rating || '-'}</td>
          <td>${a.service_rating || '-'}</td>
          <td>${a.curriculum_rating || '-'}</td>
          <td class="actions">
            <button class="btn btn-danger" onclick="deleteAttendance(${a.id})">Delete</button>
          </td>
        </tr>
      `).join('');
    }

    document.getElementById('attendance-search')?.addEventListener('input', renderAttendance);

    document.getElementById('attendance-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const record = {
        person_id: document.getElementById('attendance-person').value,
        week_id: document.getElementById('attendance-week').value,
        status: document.getElementById('attendance-status').value,
        reported_by: DATA.usrah[0]?.usrah_id || 'admin',
        reported_at: new Date().toISOString().split('T')[0],
        brotherhood_rating: parseInt(document.getElementById('attendance-brotherhood').value),
        service_rating: parseInt(document.getElementById('attendance-service').value),
        curriculum_rating: parseInt(document.getElementById('attendance-curriculum').value)
      };
      
      try {
        const { data, error } = await supabase.from('attendance').insert([record]);
        if (error) throw error;
        
        await loadDataFromSupabase();
        renderAttendance();
        showMessage('attendance-message', '‚úì Attendance record added!');
      } catch (err) {
        showMessage('attendance-message', 'Error: ' + err.message, true);
      }
    });

    function deleteAttendance(id) {
      if (confirm('Delete this attendance record?')) {
        supabase.from('attendance').delete().eq('id', id).then(() => {
          loadDataFromSupabase().then(() => {
            renderAttendance();
            showMessage('attendance-message', '‚úì Record deleted');
          });
        });
      }
    }

    // SETTINGS
    document.getElementById('settings-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      try {
        // For now, settings are stored in DATA object only
        DATA.settings.windowMonths = parseInt(document.getElementById('settings-window').value);
        DATA.settings.USE_GOOGLE_SHEETS = document.getElementById('settings-google-sheets').checked;
        showMessage('settings-message', '‚úì Settings saved locally!');
      } catch (err) {
        showMessage('settings-message', 'Error: ' + err.message, true);
      }
    });

    function loadSettings() {
      document.getElementById('settings-window').value = DATA.settings.windowMonths || 2;
      document.getElementById('settings-google-sheets').checked = DATA.settings.USE_GOOGLE_SHEETS || false;
    }

    // IMPORT/EXPORT
    function exportData() {
      const dataStr = JSON.stringify(DATA, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `usrah-data-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function importData() {
      const file = document.getElementById('import-file').files[0];
      if (!file) {
        showMessage('import-message', 'Please select a file', true);
        return;
      }

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          DATA = JSON.parse(e.target.result);
          saveData();
          renderAll();
          showMessage('import-message', '‚úì Data imported successfully!');
        } catch (err) {
          showMessage('import-message', 'Error importing file: ' + err.message, true);
        }
      };
      reader.readAsText(file);
    }

    function resetData() {
      if (confirm('Are you sure? This will delete ALL data in Supabase and restore sample data!')) {
        alert('Reset functionality requires manual SQL execution. Please contact your admin.');
      }
    }

    async function renderAll() {
      renderUsrahs();
      renderMembers();
      renderWeeks();
      renderAttendance();
      loadSettings();
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', async () => {
      await initSupabase();
      renderAll();
    });
  </script>
</body>
</html>
