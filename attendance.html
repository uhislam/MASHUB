<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=5.0, user-scalable=yes">
  <title>Submit Usrah Attendance</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <script src="api-client.js"></script>
  <style>
    :root {
      --accent: #22d3ee;
      --border: #233045;
      --text: #e5e7eb;
      --muted: #94a3b8;
      --bg: #0b1120;
      --surface: #0f172a;
    }
    body { margin: 0; font-family: 'Inter', sans-serif; background: radial-gradient(1200px 600px at 50% -200px, #0b1120 0%, #050b16 100%); color: var(--text); }
    main { max-width: 900px; margin: 40px auto; padding: 24px; background: var(--surface); border: 1px solid var(--border); border-radius: 12px; }
    h1 { font-family: 'Press Start 2P', cursive; font-size: 22px; color: var(--accent); text-align: center; margin: 0 0 16px; letter-spacing: 1px; }
    .form-row { display: flex; gap: 10px; flex-wrap: wrap; }
    label { font-weight: 600; }
    input, select, button { font: inherit; }
    input, select { padding: 10px 12px; border: 1px solid var(--border); border-radius: 6px; background: #0b1225; color: var(--text); min-width: 200px; }
    button { padding: 10px 14px; border-radius: 8px; border: 1px solid var(--accent); background: var(--accent); color: #0b1120; cursor: pointer; font-weight: 700; }
    button:hover { background: #0b132b; }
    .member-attendance { display: flex; justify-content: space-between; align-items: center; padding: 12px; margin-bottom: 8px; background: #0b1225; border: 1px solid var(--border); border-radius: 6px; }
    .attendance-buttons { display: flex; gap: 8px; }
    .attendance-buttons button { border-color: var(--border); background: #0b132b; color: var(--text); }
    .attendance-buttons button.selected { background: var(--accent); color: #0b1120; border-color: var(--accent); }
    .success { color: #22c55e; }
    .error { color: #ef4444; }
    .nav { display:flex; justify-content: space-between; margin-bottom: 12px; }
    .link { color: var(--accent); text-decoration: none; font-weight: 700; }
    .metric-editor { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-top: 8px; }
    .metric-input { display: flex; flex-direction: column; }
    .metric-input label { font-size: 10px; color: var(--muted); margin-bottom: 4px; }
    .metric-input input[type="range"] { width: 100%; }
    .metric-value { font-size: 12px; font-weight: 600; color: var(--accent); }
    #usra-title { color: var(--accent); background: transparent; border: none; padding: 0; margin: 16px 0; }
    
    input[type="range"] {
      -webkit-appearance: none;
      appearance: none;
      background: transparent;
      cursor: pointer;
    }
    input[type="range"]::-webkit-slider-track {
      background: var(--border);
      height: 8px;
      border-radius: 4px;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      margin-top: -6px;
      background: var(--accent);
      height: 20px;
      width: 20px;
      border-radius: 50%;
      border: 2px solid #0b1120;
      box-shadow: 0 0 8px var(--accent);
    }
    input[type="range"]::-moz-range-track {
      background: var(--border);
      height: 8px;
      border-radius: 4px;
    }
    input[type="range"]::-moz-range-thumb {
      background: var(--accent);
      height: 20px;
      width: 20px;
      border-radius: 50%;
      border: 2px solid #0b1120;
      box-shadow: 0 0 8px var(--accent);
    }
  </style>
</head>
<body>
  <main>
    <div class="nav">
      <a class="link" href="index.html">← Back to Dashboard</a>
    </div>
    <h1>Submit Attendance</h1>
    <p>Select your Usrah and submit attendance with metrics for each member.</p>

    <div style="margin-bottom: 20px;">
      <label for="usrah-select">Select your Usrah:</label>
      <div class="form-row" style="margin-top:6px; margin-bottom:12px;">
        <select id="usrah-select" onchange="selectUsrah()">
          <option value="">-- Choose your Usrah --</option>
        </select>
      </div>
    </div>

    <div id="attendance-form" class="attendance-form" style="display:none;">
      <h3 id="usra-title"></h3>
      <label for="week-select">Select Week:</label>
      <select id="week-select" onchange="updateAttendanceForm()">
        <option value="">-- Select a week --</option>
      </select>
      
      <div style="margin-top: 20px; padding: 16px; background: #0b132b; border: 1px solid var(--border); border-radius: 6px;">
        <label style="font-weight: 700; color: var(--accent);">Overall Usrah Metrics</label>
        <div class="metric-editor">
          <div class="metric-input">
            <label>Brotherhood: <span class="metric-value" id="overall-brotherhood-value">3</span></label>
            <input type="range" id="overall-brotherhood-rating" min="1" max="5" value="3" step="1" oninput="document.getElementById('overall-brotherhood-value').textContent = this.value">
          </div>
          <div class="metric-input">
            <label>Curricular Progress: <span class="metric-value" id="overall-curriculum-value">3</span></label>
            <input type="range" id="overall-curriculum-rating" min="1" max="5" value="3" step="1" oninput="document.getElementById('overall-curriculum-value').textContent = this.value">
          </div>
        </div>
      </div>

      <div id="members-list" style="margin-top: 20px;"></div>
      <div class="form-row" style="margin-top: 12px;">
        <button onclick="submitAttendance()">Submit Attendance</button>
        <button class="secondary" onclick="resetForm()">Cancel</button>
      </div>
      <div id="submit-message" style="margin-top: 10px;"></div>
    </div>
  </main>
  <script>
    // Minimal shared sample data (fallback)
    const DATA = {
      settings: { windowMonths: 2 },
      usrah: [
        { usrah_id: "u1", usrah_name: "North River" },
        { usrah_id: "u2", usrah_name: "East Grove" },
        { usrah_id: "u3", usrah_name: "Westfield" }
      ],
      people: [
        { person_id: "p1", name: "Aisha Rahman", usrah_id: "u1", active: true },
        { person_id: "p2", name: "Fatimah Khan", usrah_id: "u1", active: true },
        { person_id: "p3", name: "Yusuf Malik", usrah_id: "u1", active: true },
        { person_id: "p4", name: "Ismail Odeh", usrah_id: "u2", active: true },
        { person_id: "p5", name: "Maryam Said", usrah_id: "u2", active: true },
        { person_id: "p7", name: "Omar Saleh", usrah_id: "u3", active: true },
        { person_id: "p8", name: "Sarah Idris", usrah_id: "u3", active: true },
        { person_id: "p9", name: "Bilal Karim", usrah_id: "u3", active: true }
      ],
      weeks: [
        { week_id: "2025-W09", start_date: "2025-03-03", end_date: "2025-03-09" },
        { week_id: "2025-W10", start_date: "2025-03-10", end_date: "2025-03-16" },
        { week_id: "2025-W11", start_date: "2025-03-17", end_date: "2025-03-23" },
        { week_id: "2025-W12", start_date: "2025-03-24", end_date: "2025-03-30" }
      ],
      attendance: []
    };

    // API Integration
    const API_URL = 'http://localhost:3000';
    const api = new MASHUBApi(API_URL);

    async function loadDataFromBackend() {
      try {
        const [usrahData, peopleData, weeksData] = await Promise.all([
          api.loadUsrah(),
          api.loadPeople(),
          api.loadWeeks()
        ]);
        
        DATA.usrah = usrahData;
        DATA.people = peopleData;
        DATA.weeks = weeksData;
        
        console.log('✓ Data loaded from backend');
      } catch (err) {
        console.warn('Backend not available, using fallback data:', err.message);
      }
    }

    const latestWeekEnd = DATA.weeks.reduce((latest, week) => {
      const end = new Date(week.end_date);
      return end > latest ? end : latest;
    }, new Date(0));
    const cutoffDate = new Date(latestWeekEnd);
    cutoffDate.setMonth(cutoffDate.getMonth() - DATA.settings.windowMonths);
    const visibleWeeks = DATA.weeks.filter(week => new Date(week.end_date) >= cutoffDate);
    const weekOptions = [...visibleWeeks].reverse();

    let currentUsra = null;
    let attendanceData = {};
    let memberMetrics = {};

    // Initialize usrah dropdown
    async function initializeUsrahDropdown() {
      await loadDataFromBackend();
      const select = document.getElementById('usrah-select');
      select.innerHTML = '<option value="">-- Choose your Usrah --</option>' +
        DATA.usrah.map(u => `<option value="${u.usrah_id}">${u.usrah_name}</option>`).join('');
    }
    }

    function selectUsrah() {
      const usrahId = document.getElementById('usrah-select').value;
      const formEl = document.getElementById('attendance-form');
      
      if (!usrahId) {
        formEl.style.display = 'none';
        return;
      }
      
      currentUsra = DATA.usrah.find(u => u.usrah_id === usrahId);
      document.getElementById('usra-title').textContent = `Submit attendance for ${currentUsra.usrah_name}`;
      
      const weekSelect = document.getElementById('week-select');
      weekSelect.innerHTML = '<option value="">-- Select a week --</option>' + 
        weekOptions.map(w => `<option value="${w.week_id}">${w.week_id} (${new Date(w.start_date).toLocaleDateString()} - ${new Date(w.end_date).toLocaleDateString()})</option>`).join('');
      
      formEl.style.display = 'block';
      attendanceData = {};
      memberMetrics = {};
    }

    function updateAttendanceForm() {
      const weekId = document.getElementById('week-select').value;
      const membersList = document.getElementById('members-list');
      if (!weekId || !currentUsra) { membersList.innerHTML = ''; return; }
      
      const members = DATA.people.filter(p => p.usrah_id === currentUsra.usrah_id && p.active);
      membersList.innerHTML = members.map(member => {
        const currentStatus = attendanceData[member.person_id] || '';
        const metrics = memberMetrics[member.person_id] || {
          brotherhood: 3, pdpCompliance: 0, quran: 3, activism: 3, leadership: 3, chapter: 3, membership: 1
        };
        
        return `
          <div style="margin-bottom: 16px; padding: 12px; background: #0b132b; border: 1px solid var(--border); border-radius: 6px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <span style="font-weight: 600; color: var(--text);">${member.name}</span>
              <div class="attendance-buttons">
                <button class="${currentStatus === 'present' ? 'selected' : ''}" onclick="markAttendance('${member.person_id}', 'present')">Present</button>
                <button class="${currentStatus === 'absent' ? 'selected' : ''}" onclick="markAttendance('${member.person_id}', 'absent')">Absent</button>
                <button class="${currentStatus === 'excused' ? 'selected' : ''}" onclick="markAttendance('${member.person_id}', 'excused')">Excused</button>
              </div>
            </div>
            <div class="metric-editor">
              <div class="metric-input">
                <label>Brotherhood: <span class="metric-value">${metrics.brotherhood}</span></label>
                <input type="range" min="1" max="5" value="${metrics.brotherhood}" step="1" oninput="updateMetric('${member.person_id}', 'brotherhood', this.value)">
              </div>
              <div class="metric-input">
                <label>PDP: <span class="metric-value">${metrics.pdpCompliance}</span></label>
                <input type="range" min="0" max="1" value="${metrics.pdpCompliance}" step="1" oninput="updateMetric('${member.person_id}', 'pdpCompliance', this.value)">
              </div>
              <div class="metric-input">
                <label>Quran: <span class="metric-value">${metrics.quran}</span></label>
                <input type="range" min="1" max="5" value="${metrics.quran}" step="1" oninput="updateMetric('${member.person_id}', 'quran', this.value)">
              </div>
              <div class="metric-input">
                <label>Activism: <span class="metric-value">${metrics.activism}</span></label>
                <input type="range" min="1" max="5" value="${metrics.activism}" step="1" oninput="updateMetric('${member.person_id}', 'activism', this.value)">
              </div>
              <div class="metric-input">
                <label>Leadership: <span class="metric-value">${metrics.leadership}</span></label>
                <input type="range" min="1" max="5" value="${metrics.leadership}" step="1" oninput="updateMetric('${member.person_id}', 'leadership', this.value)">
              </div>
              <div class="metric-input">
                <label>Chapter: <span class="metric-value">${metrics.chapter}</span></label>
                <input type="range" min="1" max="5" value="${metrics.chapter}" step="1" oninput="updateMetric('${member.person_id}', 'chapter', this.value)">
              </div>
              <div class="metric-input">
                <label>Membership: <span class="metric-value">${metrics.membership}</span></label>
                <input type="range" min="1" max="5" value="${metrics.membership}" step="1" oninput="updateMetric('${member.person_id}', 'membership', this.value)">
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function markAttendance(personId, status) {
      attendanceData[personId] = status;
      updateAttendanceForm();
    }

    function updateMetric(personId, metric, value) {
      if (!memberMetrics[personId]) memberMetrics[personId] = {};
      memberMetrics[personId][metric] = parseInt(value);
    }

    async function submitAttendance() {
      const weekId = document.getElementById('week-select').value;
      const messageEl = document.getElementById('submit-message');
      if (!weekId) { messageEl.innerHTML = '<span class="error">Please select a week</span>'; return; }
      
      const overallBrotherhood = parseInt(document.getElementById('overall-brotherhood-rating').value);
      const overallCurriculum = parseInt(document.getElementById('overall-curriculum-rating').value);

      const members = DATA.people.filter(p => p.usrah_id === currentUsra.usrah_id && p.active);
      const allMarked = members.every(m => attendanceData[m.person_id]);
      if (!allMarked) { messageEl.innerHTML = '<span class="error">Please mark attendance for all members</span>'; return; }
      
      const today = new Date().toISOString().split('T')[0];
      const records = members.map(member => {
        const metrics = memberMetrics[member.person_id] || {
          brotherhood: 3, pdpCompliance: 0, quran: 3, activism: 3, leadership: 3, chapter: 3, membership: 1
        };
        return { 
          person_id: member.person_id, 
          week_id: weekId, 
          status: attendanceData[member.person_id], 
          reported_by: currentUsra.usrah_id, 
          reported_at: today,
          brotherhood: metrics.brotherhood,
          pdpCompliance: metrics.pdpCompliance,
          quran: metrics.quran,
          activism: metrics.activism,
          leadership: metrics.leadership,
          chapter: metrics.chapter,
          membership: metrics.membership,
          overall_brotherhood: overallBrotherhood,
          overall_curriculum: overallCurriculum
        };
      });
      
      try {
        await api.submitAttendance(records);
        messageEl.innerHTML = '<span class="success">✓ Attendance submitted successfully! Redirecting…</span>';
        setTimeout(() => { window.location.href = 'index.html'; }, 1200);
      } catch (err) {
        messageEl.innerHTML = '<span class="error">Error submitting attendance: ' + err.message + '</span>';
      }
    }

    function resetForm() {
      document.getElementById('usrah-select').value = '';
      document.getElementById('attendance-form').style.display = 'none';
      document.getElementById('members-list').innerHTML = '';
      document.getElementById('submit-message').innerHTML = '';
      document.getElementById('overall-brotherhood-rating').value = '3';
      document.getElementById('overall-curriculum-rating').value = '3';
      document.getElementById('overall-brotherhood-value').textContent = '3';
      document.getElementById('overall-curriculum-value').textContent = '3';
      currentUsra = null;
      attendanceData = {};
      memberMetrics = {};
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', initializeUsrahDropdown);
  </script>
</body>
</html>
